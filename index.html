
<script>
  // Google Apps Script API URLï¼ˆDriveé€£æºç”¨ï¼‰
  const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

  let currentSeat = null;   // ç¾åœ¨ç™»éŒ²ä¸­ã®åº§å¸­ID
  let seatMap = {};        // { seatID: [playerID, ...] }
  let actionHistory = [];  // æ“ä½œå±¥æ­´ï¼ˆundoç”¨ï¼‰
  let lastScanTime = 0;    // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ç”¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  let isRankingMode = false;  // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
  let playerMap = {};
  let currentSeat = null;
  let seatMap = {};
  let actionHistory = [];
  let playerMap = JSON.parse(localStorage.getItem("playerMap") ||"{}")

  // äº‹å‰ã«localStorageã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆä»»æ„ã€åˆæœŸã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  let players = JSON.parse(localStorage.getItem("players") || "{}");

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã€QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹
  document.addEventListener("DOMContentLoaded", async () => {
    const savedMap = localStorage.getItem("seatMap");
    if (savedMap) {
      seatMap = JSON.parse(savedMap);
      displayMessage("ğŸ“¦ å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
      updateTable();
    } else {
      await loadSeatMapFromDrive();
    }

    startQrCodeScanner();
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
    updateCurrentSeatDisplay();
  });

  function initGoogleAPI() {
    gapi.load("client:auth2", () => {
      gapi.client.init({
        apiKey: "YOUR_API_KEY",
        clientId: "YOUR_CLIENT_ID.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/drive.file"
      }).then(() => {
        console.log("âœ… Google API åˆæœŸåŒ–å®Œäº†");
      }).catch(e => {
        console.error("âŒ Google API åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", e);
      });
    });
  }

  // DOMãƒ­ãƒ¼ãƒ‰å¾Œã«åˆæœŸåŒ–
  window.addEventListener("load", initGoogleAPI);
  // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•
  function startQrCodeScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.33
      },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
      displayMessage("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
    });
  }

  // èª­ã¿å–ã‚Šå¤±æ•—æ™‚ï¼ˆç‰¹ã«ç„¡è¦–ï¼‰
  function onScanFailure(error) {
    // noop
  }

  // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return; // 2ç§’ä»¥å†…é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
    lastScanTime = now;

    // å½¢å¼ãƒã‚§ãƒƒã‚¯
    if (!/^(table|player)/.test(decodedText)) {
      displayMessage("â—ä¸æ­£ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚'tableã€œ' ã¾ãŸã¯ 'playerã€œ' ã§å§‹ã‚ã¦ãã ã•ã„ã€‚");
      return;
    }

    if (isRankingMode) {
      if (decodedText.startsWith("table")) {
        if (!seatMap[decodedText]) {
          displayMessage(`âš  åº§å¸­ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${decodedText}`);
          return;
        }
        showRankingSelection(decodedText);
      } else {
        displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº§å¸­QRã®ã¿èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
      }
      return;
    }

    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
    if (decodedText.startsWith("table")) {
      currentSeat = decodedText;
      if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
      displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚æœ€å¤§6äººã¾ã§ç™»éŒ²å¯èƒ½ã€‚`);
      updateCompleteSeatBtn(true);
      updateTable();
      updateCurrentSeatDisplay();
      return;
    }

    if (decodedText.startsWith("player")) {
      if (!currentSeat) {
        displayMessage("æœ€åˆã«åº§å¸­QRï¼ˆtableã€œï¼‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
        return;
      }
      const people = seatMap[currentSeat];
      if (people.length >= 6) {
        displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã¯6äººã¾ã§ã§ã™ã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚`);
        completeCurrentSeat();
        updateCurrentSeatDisplay();
        return;
      }
      if (people.includes(decodedText)) {
        displayMessage(`ã€Œ${decodedText}ã€ã¯æ—¢ã«åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
        return;
      }
      people.push(decodedText);
      actionHistory.push({ seat: currentSeat, person: decodedText });
      displayMessage(`ã€Œ${decodedText}ã€ã‚’åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ï¼ˆ${people.length}/6ï¼‰`);
      if (people.length >= 6) {
        displayMessage("ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚");
        completeCurrentSeat();
      }
      updateTable();
      updateCurrentSeatDisplay();
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ›´æ–°
function displayMessage(text) {
  const msgEl = document.getElementById("messageBox");
  if (msgEl) {
    msgEl.textContent = text;
    msgEl.style.opacity = 1;
    setTimeout(() => { msgEl.style.opacity = 0; }, 4000);
  } else {
    alert(text);
  }
}
  
// ========== ã€Œç™»éŒ²å®Œäº†ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ==========

function updateCompleteSeatBtn(show) {
  const btn = document.getElementById("completeSeatBtn");
  if (!btn) return;
  btn.style.display = show ? "inline-block" : "none";
}

// ========== ã€Œé †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–° ==========

function updateRankingToggleButton() {
  const btn = document.getElementById("toggleRankingBtn");
  if (!btn) return;
  btn.setAttribute("aria-pressed", isRankingMode.toString());
  btn.textContent = isRankingMode ? "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†" : "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿";
}

// ========== ç¾åœ¨ã®åº§å¸­è¡¨ç¤ºæ›´æ–° ==========

function updateCurrentSeatDisplay() {
  const el = document.getElementById("currentSeatText");
  if (!el) return;

  if (!currentSeat) {
    el.textContent = "æœªé¸æŠ";
    el.style.color = "#666";
    el.style.fontWeight = "normal";
  } else {
    const peopleCount = seatMap[currentSeat]?.length || 0;
    el.textContent = `${currentSeat} ï¼ˆç™»éŒ²æ¸ˆã¿ ${peopleCount} / 6 äººï¼‰`;
    el.style.color = "#5d4037";
    el.style.fontWeight = "bold";
  }
}
// ========== åº§å¸­ä¸€è¦§è¡¨ç¤ºæ›´æ–° ==========

function updateTable() {
  const listEl = document.getElementById("seatTable tbody");
  if (!listEl) return;

  listEl.innerHTML = ""; // ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢

  // seatMapã®å…¨åº§å¸­ã‚’è¡¨ç¤º
  for (const seatId of Object.keys(seatMap).sort()) {
    const playersInSeat = seatMap[seatId];

    const li = document.createElement("li");
    li.className = "seat-item";
    li.dataset.seatid = seatId;

    const title = document.createElement("strong");
    title.textContent = seatId + "ï¼š";
    li.appendChild(title);

    // ç™»éŒ²ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º
    const namesSpan = document.createElement("span");
    namesSpan.className = "player-names";
    namesSpan.textContent = playersInSeat.length
      ? playersInSeat.join(", ")
      : "ï¼ˆæœªç™»éŒ²ï¼‰";
    li.appendChild(namesSpan);

    // å–æ¶ˆãƒœã‚¿ãƒ³ï¼ˆ1ã¤ãšã¤å–ã‚Šæ¶ˆã—ï¼‰
    if (playersInSeat.length > 0) {
      const undoBtn = document.createElement("button");
      undoBtn.textContent = "å–æ¶ˆ";
      undoBtn.className = "undo-btn";
      undoBtn.addEventListener("click", () => {
        undoLastRegistration(seatId);
      });
      li.appendChild(undoBtn);
    }

    // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆåº§å¸­ã¾ã‚‹ã”ã¨å‰Šé™¤ï¼‰
    const delBtn = document.createElement("button");
    delBtn.textContent = "å‰Šé™¤";
    delBtn.className = "delete-btn";
    delBtn.addEventListener("click", () => {
      if (confirm(`åº§å¸­ã€Œ${seatId}ã€ã®ç™»éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚ˆã„ã§ã™ã‹ï¼Ÿ`)) {
        deleteSeat(seatId);
      }
    });
    li.appendChild(delBtn);

    listEl.appendChild(li);
  }
}

// ========== ç™»éŒ²å–æ¶ˆï¼ˆæœ€å¾Œã«è¿½åŠ ã—ãŸäººã‚’å–ã‚Šæ¶ˆã™ï¼‰ ==========

function undoLastRegistration(seatId) {
  // actionHistoryã‹ã‚‰å¯¾è±¡ã®seatIdæœ€å¾Œã®ç™»éŒ²ã‚’æ¢ã™
  for (let i = actionHistory.length - 1; i >= 0; i--) {
    const action = actionHistory[i];
    if (action.seat === seatId) {
      // ç™»éŒ²è§£é™¤
      const idx = seatMap[seatId].indexOf(action.person);
      if (idx !== -1) {
        seatMap[seatId].splice(idx, 1);
        actionHistory.splice(i, 1);
        displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã®ã€Œ${action.person}ã€ç™»éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚`);
        saveSeatMapLocal();
        updateTable();
        updateCurrentSeatDisplay();
        updateCompleteSeatBtn(true);
      }
      return;
    }
  }
  displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã«å–ã‚Šæ¶ˆã›ã‚‹ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
}

function toggleRankingMode() {
  isRankingMode = !isRankingMode;
  updateRankingToggleButton();

  if (isRankingMode) {
    // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ãŸã‚‰ç¾åœ¨ã®åº§å¸­ç™»éŒ²ã¯å®Œäº†çŠ¶æ…‹ã«ã—ã¦ãŠã
    currentSeat = null;
    updateCurrentSeatDisplay();
    displayMessage("ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸã€‚åº§å¸­QRã‚’èª­ã¿å–ã£ã¦é †ä½ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");

    // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ç”¨UIã‚’è¡¨ç¤º
    showRankingSelectionUI();
  } else {
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã£ãŸã‚‰
    displayMessage("é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
    hideRankingSelectionUI();
  }
}
function showRankingSelectionUI() {
  const ui = document.getElementById("ranking-select-ui");
  if (!ui) return;
  ui.style.display = "block";

  // åº§å¸­ä¸€è¦§ã‚’å–å¾—ã—ã¦ç©ºãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
  const rankingList = document.getElementById("rankingList");
  rankingList.innerHTML = "";

  // ã™ã¹ã¦ã®åº§å¸­ã”ã¨ã«ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œã‚‹ï¼ˆä¾‹ã¨ã—ã¦åº§å¸­IDã®ã¿ï¼‰
  Object.keys(seatMap).sort().forEach(seatId => {
    const li = document.createElement("li");
    li.textContent = seatId;
    li.setAttribute("draggable", "true");
    li.dataset.seatId = seatId;
    rankingList.appendChild(li);
  });

  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆ
  enableDragAndDrop(rankingList);
}

function hideRankingSelectionUI() {
  const ui = document.getElementById("ranking-select-ui");
  if (!ui) return;
  ui.style.display = "none";
}
function enableDragAndDrop(listEl) {
  let dragged = null;

  listEl.querySelectorAll("li").forEach(li => {
    li.addEventListener("dragstart", e => {
      dragged = li;
      li.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    li.addEventListener("dragend", e => {
      dragged.classList.remove("dragging");
      dragged = null;
    });
    li.addEventListener("dragover", e => {
      e.preventDefault();
      if (li !== dragged) {
        const bounding = li.getBoundingClientRect();
        const offset = bounding.y + bounding.height / 2;
        const parent = li.parentNode;
        if (e.clientY - offset > 0) {
          parent.insertBefore(dragged, li.nextSibling);
        } else {
          parent.insertBefore(dragged, li);
        }
      }
    });
  });
}
function confirmRanking() {
  if (!isRankingMode) {
    displayMessage("é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const rankingList = document.getElementById("rankingList");
  const newOrder = Array.from(rankingList.children).map(li => li.dataset.seatId);

  // ã“ã“ã§ newOrder ã«é †ä½ï¼ˆ1ä½ã€œï¼‰ã‚’ä»˜ä¸ã—ã¦seatMapãªã©ã«åæ˜ å¯èƒ½
  // ä¾‹ã¨ã—ã¦å„åº§å¸­ã«é †ä½ã‚’ä»˜ã‘ã¦ä¿å­˜ã™ã‚‹
  newOrder.forEach((seatId, index) => {
    if (!seatMap[seatId]) return;
    seatMap[seatId].rank = index + 1;
  });

  displayMessage("é †ä½ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚");
  isRankingMode = false;
  updateRankingToggleButton();
  hideRankingSelectionUI();
  updateTable();
}

  
// ========== åº§å¸­ç™»éŒ²å‰Šé™¤ï¼ˆåº§å¸­ã”ã¨æ¶ˆã™ï¼‰ ==========

function deleteSeat(seatId) {
  if (!seatMap[seatId]) return;
  delete seatMap[seatId];

  // actionHistoryã‹ã‚‰ã‚‚è©²å½“seatIdã®å±¥æ­´ã‚’å‰Šé™¤
  actionHistory = actionHistory.filter(a => a.seat !== seatId);

  displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã®ç™»éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
  if (seatId === currentSeat) {
    currentSeat = null;
    updateCompleteSeatBtn(false);
    updateCurrentSeatDisplay();
  }
  saveSeatMapLocal();
  updateTable();
}

// ========== åº§å¸­ç™»éŒ²å®Œäº†å‡¦ç† ==========

async function completeCurrentSeat() {
  if (!currentSeat) return;

  // 6äººæœªæº€ã§ã‚‚ç™»éŒ²å®Œäº†ã‚’è¨±å¯
  displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚`);
  currentSeat = null;

  updateCompleteSeatBtn(false);
  updateCurrentSeatDisplay();

  saveSeatMapLocal();

  // ã“ã“ã§Google Driveä¿å­˜ã‚’å‘¼ã³å‡ºã—ï¼ˆéåŒæœŸï¼‰
  await saveSeatMapToDrive();
}

// ========== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ ==========

function saveSeatMapLocal() {
  localStorage.setItem("seatMap", JSON.stringify(seatMap));
}

// ========== Google Driveã¸ä¿å­˜å‘¼ã³å‡ºã— ==========

async function saveSeatMapToDrive() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ command: "saveSeatMap", data: seatMap }),
      headers: { "Content-Type": "application/json" }
    });
    const json = await res.json();
    if (json.result === "success") {
      displayMessage("âœ… Google Driveã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
    } else {
      displayMessage("âš  Google Driveã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (e) {
    displayMessage("âš  Google Driveä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    console.error(e);
  }
}

// ========== Google Driveã‹ã‚‰ã®èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸåŒ–æ™‚ï¼‰ ==========

async function loadSeatMapFromDrive() {
  try {
    const res = await fetch(API_URL + "?command=loadSeatMap");
    const json = await res.json();
    if (json.result === "success" && json.data) {
      seatMap = json.data;
      displayMessage("ğŸ“¥ Google Driveã‹ã‚‰åº§å¸­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
      updateTable();
      saveSeatMapLocal(); // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
    } else {
      displayMessage("â„¹ Google Driveã«åº§å¸­ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
  } catch (e) {
    displayMessage("âš  Google Driveã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    console.error(e);
  }
}
// ========== é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿å–ã‚Šã¨ç™»éŒ² ==========

let rankingList = [];  // ç™»éŒ²ã•ã‚ŒãŸplayerIDã®é…åˆ—

function handlePlayerForRanking(playerId) {
  if (!playerId.startsWith("player-")) {
    displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯ player- ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (rankingList.includes(playerId)) {
    displayMessage(`âš  ${playerMap[playerId]?.name || playerId} ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚`);
    return;
  }

  rankingList.push(playerId);
  displayMessage(`${playerMap[playerId]?.name || playerId} ã‚’é †ä½ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
  updateRankingUI();
}

// ========== é †ä½ç™»éŒ²UIæ›´æ–°ï¼ˆä¸¦ã³æ›¿ãˆå¯èƒ½ãƒªã‚¹ãƒˆï¼‰ ==========

function updateRankingUI() {
  const rankingListEl = document.getElementById("rankingList");
  if (!rankingListEl) return;
  rankingListEl.innerHTML = "";

  rankingList.forEach((id, idx) => {
    const li = document.createElement("li");
    li.className = "ranking-item";
    li.draggable = true;
    li.dataset.playerId = id;
    li.textContent = `${idx + 1}. ${playerMap[id]?.name || id}`;
    rankingListEl.appendChild(li);
  });

  makeRankingSortable();
}

// ========== ä¸¦ã³æ›¿ãˆå¯èƒ½ã«ã™ã‚‹ï¼ˆPCã¨ã‚¹ãƒãƒ›å¯¾å¿œï¼‰ ==========

function makeRankingSortable() {
  const list = document.getElementById("rankingList");
  let dragged;

  list.querySelectorAll("li").forEach(li => {
    // PCç”¨
    li.addEventListener("dragstart", e => {
      dragged = li;
      li.style.opacity = 0.5;
    });

    li.addEventListener("dragend", () => {
      dragged.style.opacity = "";
    });

    li.addEventListener("dragover", e => {
      e.preventDefault();
    });

    li.addEventListener("drop", e => {
      e.preventDefault();
      if (dragged && dragged !== li) {
        const draggedId = dragged.dataset.playerId;
        const targetId = li.dataset.playerId;

        const fromIdx = rankingList.indexOf(draggedId);
        const toIdx = rankingList.indexOf(targetId);

        rankingList.splice(fromIdx, 1);
        rankingList.splice(toIdx, 0, draggedId);

        updateRankingUI();
      }
    });

    // ã‚¹ãƒãƒ›ç”¨
    li.addEventListener("touchstart", e => {
      dragged = li;
      dragged.classList.add("dragged");
    });

    li.addEventListener("touchend", e => {
      dragged?.classList.remove("dragged");
      dragged = null;
    });

    li.addEventListener("touchmove", e => {
      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (dragged && target && target.closest && target.closest("li")) {
        const overLi = target.closest("li");
        const draggedId = dragged.dataset.playerId;
        const overId = overLi.dataset.playerId;

        if (draggedId !== overId) {
          const fromIdx = rankingList.indexOf(draggedId);
          const toIdx = rankingList.indexOf(overId);

          rankingList.splice(fromIdx, 1);
          rankingList.splice(toIdx, 0, draggedId);
          updateRankingUI();
        }
      }
    });
  });
}

// ========== é †ä½ç¢ºå®šãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚å‡¦ç† ==========

function confirmRanking() {
  if (rankingList.length === 0) {
    displayMessage("âš  é †ä½ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  if (!confirm("ã“ã®é †ä½ã§ç¢ºå®šã—ã¦ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;

  applyRankingAndCalculateRating(rankingList);
  displayMessage("âœ… é †ä½ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");

  rankingList = [];
  updateRankingUI();
  updateRateTable();
}

// ========== ãƒ¬ãƒ¼ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®ä¾‹ï¼ˆè‡ªç”±ã«æ‹¡å¼µå¯èƒ½ï¼‰ ==========

function applyRankingAndCalculateRating(list) {
  const n = list.length;

  list.forEach((playerId, idx) => {
    const player = playerMap[playerId];
    if (!player) return;

    const prevRate = player.rate || 50;
    let bonus = 0;

    // å˜ç´”ãªä¾‹ï¼š1ä½ +5, 2ä½ +2, 3ä½Â±0, ä»¥ä¸‹ -3
    if (idx === 0) bonus = 5;
    else if (idx === 1) bonus = 2;
    else if (idx === 2) bonus = 0;
    else bonus = -3;

    // ä¸Šé™ãƒ»ä¸‹é™è£œæ­£
    let newRate = Math.max(30, Math.min(99, prevRate + bonus));

    // ä¿å­˜
    player.prevRate = prevRate;
    player.rate = newRate;
    player.lastRank = idx + 1;
    player.bonus = bonus;
  });

  savePlayerMapLocal();
}

// ========== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ ==========

function savePlayerMapLocal() {
  localStorage.setItem("playerMap", JSON.stringify(playerMap));
}

// ========== ãƒ¬ãƒ¼ãƒˆè¡¨UIæ›´æ–° ==========

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
    `;
    table.appendChild(tr);
  });
}
// ========== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ==========

function exportCSV() {
  const header = ["åå‰", "ãƒ¬ãƒ¼ãƒˆ", "å‰å›é †ä½", "å¤‰å‹•", "ç§°å·"];
  const rows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p) || ""
  ]);

  const csvContent = [header, ...rows].map(row =>
    row.map(val => `"${val}"`).join(",")
  ).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "rate_result.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ä¸¦ã³æ›¿ãˆ
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.title}</td>
    `;
    table.appendChild(tr);
  });
}

// ========== Google Drive é€£æºä¿å­˜ï¼ˆå¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ ==========

async function saveToGoogleDrive(filename, data) {
  if (!window.gapi || !gapi.auth2) {
    console.warn("Google API æœªãƒ­ãƒ¼ãƒ‰ã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚");
    saveToLocalFallback(filename, data);
    return;
  }

  try {
    const authInstance = gapi.auth2.getAuthInstance();
    if (!authInstance.isSignedIn.get()) {
      await authInstance.signIn();
    }

    const fileContent = new Blob([data], { type: 'text/plain' });
    const metadata = {
      name: filename,
      mimeType: 'text/plain'
    };

    const accessToken = gapi.auth.getToken().access_token;

    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", fileContent);

    const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: new Headers({ Authorization: "Bearer " + accessToken }),
      body: form
    });

    if (res.ok) {
      displayMessage("âœ… Google Drive ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
    } else {
      console.warn("Driveä¿å­˜å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚");
      saveToLocalFallback(filename, data);
    }
  } catch (e) {
    console.error("Driveé€£æºã‚¨ãƒ©ãƒ¼", e);
    saveToLocalFallback(filename, data);
  }
}

function saveToLocalFallback(filename, data) {
  const blob = new Blob([data], { type: "text/plain;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  displayMessage("ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
}

// ========== ä¿å­˜ãƒœã‚¿ãƒ³é€£æºå‡¦ç†ï¼ˆCSVï¼‹Driveï¼‰ ==========

function saveAllData() {
  const csvHeader = ["åå‰", "ãƒ¬ãƒ¼ãƒˆ", "å‰å›é †ä½", "å¤‰å‹•", "ç§°å·"];
  const csvRows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p)
  ]);

  const csvContent = [csvHeader, ...csvRows].map(r =>
    r.map(cell => `"${cell}"`).join(",")
  ).join("\n");

  saveToGoogleDrive("rate_result.csv", csvContent);
}

// ========== æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆHTMLå´ã« #messageBox ãŒå¿…è¦ï¼‰ ==========

function displayMessage(text) {
  const msgEl = document.getElementById("messageBox");
  if (msgEl) {
    msgEl.textContent = text;
    msgEl.style.opacity = 1;
    setTimeout(() => msgEl.style.opacity = 0, 4000);
  } else {
    alert(text);
  }
}
// ========== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¼”å‡º ==========

function showPopup(text, color = "gold") {
  const popup = document.createElement("div");
  popup.textContent = text;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.padding = "1em 2em";
  popup.style.backgroundColor = color;
  popup.style.color = "#000";
  popup.style.fontSize = "24px";
  popup.style.fontWeight = "bold";
  popup.style.borderRadius = "12px";
  popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  popup.style.zIndex = "9999";
  popup.style.opacity = 1;
  document.body.appendChild(popup);

  setTimeout(() => {
    popup.style.transition = "opacity 1s ease, transform 1s ease";
    popup.style.opacity = 0;
    popup.style.transform = "translate(-50%, -70%)";
  }, 800);

  setTimeout(() => {
    popup.remove();
  }, 1800);
}

// ========== é †ä½å¤‰å‹•ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ==========

function updateRateTableWithDiff() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank ?? null,
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ä¸¦ã³æ›¿ãˆ
  rows.sort((a, b) => b.rate - a.rate);

  // é †ä½ã‚’è¨˜éŒ²
  rows.forEach((row, index) => {
    const currentRank = index + 1;
    const player = playerMap[row.id];

    // é †ä½å¤‰å‹•ãƒã‚§ãƒƒã‚¯
    if (player.lastShownRank && player.lastShownRank !== currentRank) {
      const diff = player.lastShownRank - currentRank;
      const symbol = diff > 0 ? "â†‘" : "â†“";
      const movement = Math.abs(diff);
      row.rankDiff = `${symbol}${movement}`;
    } else {
      row.rankDiff = "-";
    }

    // æ¬¡å›æ¯”è¼ƒç”¨ã«ä¿å­˜
    player.lastShownRank = currentRank;
  });

  // è¡¨æ›´æ–°
  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>å¤‰å‹•å·®</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    const bonusColor = row.bonus > 0 ? "limegreen" : row.bonus < 0 ? "tomato" : "#444";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank ?? "-"}</td>
      <td style="color:${bonusColor}">${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.rankDiff || "-"}</td>
      <td>${row.title}</td>
    `;

    // å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã«åå¿œï¼‰
    if (row.bonus !== 0) {
      tr.style.animation = "flash 0.8s";
    }

    table.appendChild(tr);
  });
}

// ========== å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³CSSã®è¿½åŠ ï¼ˆ1å›é™ã‚Šï¼‰ ==========

(function addFlashAnimationOnce() {
  const styleId = "flash-css-style";
  if (document.getElementById(styleId)) return;

  const style = document.createElement("style");
  style.id = styleId;
  style.textContent = `
    @keyframes flash {
      0% { background-color: yellow; }
      100% { background-color: inherit; }
    }
    tr[style*="animation: flash"] {
      transition: background-color 1s;
    }
  `;
  document.head.appendChild(style);
})();
    
window.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("rankingTable");
  const rawData = localStorage.getItem("players");

  if (!rawData) {
    table.innerHTML = "<tr><td colspan='6'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>";
    return;
  }

  const players = JSON.parse(rawData);
  const rows = Object.entries(players).map(([id, p]) => {
    return {
      name: p.name,
      rate: p.rate ?? 50,
      lastRank: p.lastRank ?? "-",
      bonus: p.bonus ?? 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé™é †ã§ã‚½ãƒ¼ãƒˆ
  rows.sort((a, b) => b.rate - a.rate);

  // è¡¨æç”»
  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((p, i) => {
    const tr = document.createElement("tr");
    const bonusColor = p.bonus > 0 ? "limegreen" : p.bonus < 0 ? "tomato" : "#444";
    const diff = p.lastRank === "-" ? "-" : `${p.lastRank - (i + 1)}`;
    const diffSymbol = diff > 0 ? `â†‘${Math.abs(diff)}` : diff < 0 ? `â†“${Math.abs(diff)}` : "-";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rate}</td>
      <td>${p.lastRank}</td>
      <td style="color:${bonusColor}">${p.bonus >= 0 ? "+" : ""}${p.bonus}</td>
      <td>${p.title}</td>
    `;

    table.appendChild(tr);
  });
});
</script>
<script>
// ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸç§°å·ç”Ÿæˆï¼ˆå…±é€šé–¢æ•°ï¼‰
function getTitle(player) {
  const rate = player.rate || 50;
  if (rate >= 100) return "ä¼èª¬";
  if (rate >= 90) return "ç¥";
  if (rate >= 80) return "è¦‡è€…";
  if (rate >= 70) return "çŒ›è€…";
  if (rate >= 60) return "å¸¸é€£";
  if (rate >= 50) return "ä¸€èˆ¬";
  if (rate >= 40) return "åˆå¿ƒè€…";
  return "ä¿®è¡Œä¸­";
}
</script>
</body>
</html>
