<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com;">
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  img-src 'self' data: blob: https://fonts.gstatic.com;
  style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
">
<title>QRコードリーダー（削除＆順位登録機能付き）</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* --- 基本スタイル --- */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f4f8;
    color: #333;
    margin: 0; padding: 1rem; text-align: center;
    overflow-x: hidden;
  }
  h1 {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
  }
  #currentSeatDisplay {
    margin: 1rem auto;
    font-size: 1.3rem;
    font-weight: bold;
    max-width: 480px;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background-color: #ffe082; /* 明るいオレンジ */
    color: #5d4037;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #result {
    font-weight: bold;
    background-color: #e0f7fa;
    padding: 0.8rem 1rem;
    margin: 0 auto 1.5rem;
    max-width: 480px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 3rem;
  }
  .button-group {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    max-width: 320px;
    margin: 1rem auto 3rem;
  }
  button {
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  button:hover {
    background-color: #43a047;
  }
  button:active {
    transform: scale(0.97);
  }
  #completeSeatBtn {
    background-color: #ff9800;
    display: none;
  }
  #completeSeatBtn:hover {
    background-color: #fb8c00;
  }
  table {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
    border-collapse: collapse;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  th {
    background-color: #4caf50;
    color: white;
    padding: 10px;
    text-align: left;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  .student {
    display: inline-block;
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 16px;
    margin: 4px 6px 4px 0;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .student:hover {
    background-color: #bbdefb;
  }
  .seat {
    cursor: pointer;
    color: #d32f2f;
    font-weight: bold;
    user-select: none;
    transition: color 0.3s ease;
  }
  .seat:hover {
    color: #b71c1c;
    text-decoration: underline;
  }
  #seatTable tbody tr:hover {
    background-color: #e8f5e9;
  }
  /* モーダルの順位登録UI */
  #ranking-select-ui {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    padding: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #ranking-select-ui h3 {
    margin-top: 0;
  }
  #sortable-player-list {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  #sortable-player-list li {
    padding: 8px;
    margin: 4px 0;
    background: #e3f2fd;
    border-radius: 4px;
    cursor: move;
    user-select: none;
  }
  #sortable-player-list li.dragging {
    opacity: 0.5;
  }
  /* 称号エフェクト */
  .title.top1 {
    background: linear-gradient(45deg, #f9d71c, #ffec4f, #f9d71c);
    animation: lightningGlow 1.5s infinite alternate;
    box-shadow: 0 0 8px 3px #f9d71c;
  }
  @keyframes lightningGlow {
    0% { filter: drop-shadow(0 0 5px #ffeb3b); opacity: 0.8; }
    100% { filter: drop-shadow(0 0 20px #ffeb3b); opacity: 1; }
  }
  .title.top2 {
    background: linear-gradient(90deg, #2196f3, #64b5f6, #2196f3);
    animation: waveGlow 3s infinite linear;
    box-shadow: 0 0 10px 2px #2196f3;
  }
  @keyframes waveGlow {
    0% { background-position: 0% 50%; box-shadow: 0 0 8px 2px #2196f3; }
    50% { background-position: 100% 50%; box-shadow: 0 0 15px 4px #64b5f6; }
    100% { background-position: 0% 50%; box-shadow: 0 0 8px 2px #2196f3; }
  }
  .title.top3 {
    background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
    animation: windGlow 4s infinite ease-in-out alternate;
    box-shadow: 0 0 6px 2px #81d4fa;
    color: #0277bd;
  }
  @keyframes windGlow {
    0% {
      text-shadow: 0 0 5px #b2ebf2;
      box-shadow: 0 0 6px 2px #81d4fa;
      opacity: 0.8;
    }
    100% {
      text-shadow: 0 0 15px #e0f7fa;
      box-shadow: 0 0 12px 4px #4fc3f7;
      opacity: 1;
    }
  }
  .title.last {
    background: linear-gradient(45deg, #440000, #880000, #440000);
    color: #ff4444;
    animation: deathGlow 2s infinite alternate;
    box-shadow: 0 0 10px 3px #880000;
  }
  @keyframes deathGlow {
    from {
      filter: drop-shadow(0 0 5px #ff0000);
      opacity: 0.7;
    }
    to {
      filter: drop-shadow(0 0 15px #ff0000);
      opacity: 1;
    }
  }
</style>
</head>
<body>

<h1>QRコードリーダー</h1>
<p>座席（table〜）→ 生徒（player〜）の順に読み取り。6人まで登録。生徒IDクリックで削除可能。</p>

<!-- 現在の座席選択状況表示 -->
<div id="currentSeatDisplay" aria-live="polite" role="region" aria-label="現在の座席選択状況">
  現在の座席: <span id="currentSeatText">未選択</span>
</div>

<!-- QRコード読み取り領域 -->
<div id="reader-wrapper"><div id="reader"></div></div>

<!-- 読み取り結果表示 -->
<div id="result" aria-live="polite" role="status">ここに読み取り結果が表示されます</div>

<!-- 操作ボタン群 -->
<div class="button-group" role="group" aria-label="操作ボタン群">
  <button onclick="downloadCSV()" aria-label="CSVで保存">CSVで保存</button>
  <button id="completeSeatBtn" onclick="completeCurrentSeat()" aria-label="現在の座席登録完了ボタン">この座席の登録を完了</button>
  <button onclick="undoLast()" aria-label="最後の追加を取り消す">最後の追加を取り消す</button>
  <button onclick="clearSavedData()" aria-label="保存データを削除">🗑 保存データを削除</button>
  <button onclick="saveSeatMapToDrive()" aria-label="Google Driveに保存">💾 Google Driveに保存</button>
  <button onclick="loadSeatMapFromDrive()" aria-label="Driveから復元">☁ Driveから復元</button>
  <button onclick="toggleRankingMode()" aria-pressed="false" id="toggleRankingBtn">📋 順位登録モード切替</button>
</div>

<!-- 座席と生徒の登録状況テーブル -->
<section class="footer-area" aria-label="現在の座席登録状況">
  <h2>現在の座席登録</h2>
  <table id="seatTable" role="table" aria-describedby="tableDesc">
    <caption id="tableDesc">座席IDと生徒ID一覧および順位</caption>
    <thead>
      <tr><th scope="col">座席ID</th><th scope="col">生徒ID一覧</th><th scope="col">順位</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
<script>
  // Google Apps Script API URL（Drive連携用）
  const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

  let currentSeat = null;   // 現在登録中の座席ID
  let seatMap = {};        // { seatID: [playerID, ...] }
  let actionHistory = [];  // 操作履歴（undo用）
  let lastScanTime = 0;    // 連続スキャン防止用タイムスタンプ
  let isRankingMode = false;  // 順位登録モードフラグ

  // 事前にlocalStorageからプレイヤー情報を取得（任意、初期は空オブジェクト）
  let players = JSON.parse(localStorage.getItem("players") || "{}");

  // ページ読み込み時に保存済みデータを復元し、QRコードスキャナー開始
  document.addEventListener("DOMContentLoaded", async () => {
    const savedMap = localStorage.getItem("seatMap");
    if (savedMap) {
      seatMap = JSON.parse(savedMap);
      displayMessage("📦 前回のデータを復元しました");
      updateTable();
    } else {
      await loadSeatMapFromDrive();
    }

    startQrCodeScanner();
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
    updateCurrentSeatDisplay();
  });

  // QRコードスキャナー起動
  function startQrCodeScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.33
      },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("カメラ起動エラー:", err);
      displayMessage("カメラ起動に失敗しました: " + err);
    });
  }

  // 読み取り失敗時（特に無視）
  function onScanFailure(error) {
    // noop
  }

  // 読み取り成功時コールバック
  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return; // 2秒以内連続スキャン防止
    lastScanTime = now;

    // 形式チェック
    if (!/^(table|player)/.test(decodedText)) {
      displayMessage("❗不正なQRコードです。'table〜' または 'player〜' で始めてください。");
      return;
    }

    if (isRankingMode) {
      if (decodedText.startsWith("table")) {
        if (!seatMap[decodedText]) {
          displayMessage(`⚠ 座席データが存在しません: ${decodedText}`);
          return;
        }
        showRankingSelection(decodedText);
      } else {
        displayMessage("⚠ 順位登録モードでは座席QRのみ読み取ってください。");
      }
      return;
    }

    // 通常モード
    if (decodedText.startsWith("table")) {
      currentSeat = decodedText;
      if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
      displayMessage(`座席「${currentSeat}」を読み取りました。最大6人まで登録可能。`);
      updateCompleteSeatBtn(true);
      updateTable();
      updateCurrentSeatDisplay();
      return;
    }

    if (decodedText.startsWith("player")) {
      if (!currentSeat) {
        displayMessage("最初に座席QR（table〜）を読み取ってください。");
        return;
      }
      const people = seatMap[currentSeat];
      if (people.length >= 6) {
        displayMessage(`座席「${currentSeat}」は6人までです。登録を完了します。`);
        completeCurrentSeat();
        updateCurrentSeatDisplay();
        return;
      }
      if (people.includes(decodedText)) {
        displayMessage(`「${decodedText}」は既に座席「${currentSeat}」に登録されています。`);
        return;
      }
      people.push(decodedText);
      actionHistory.push({ seat: currentSeat, person: decodedText });
      displayMessage(`「${decodedText}」を座席「${currentSeat}」に登録（${people.length}/6）`);
      if (people.length >= 6) {
        displayMessage("上限に達しました。登録を完了します。");
        completeCurrentSeat();
      }
      updateTable();
      updateCurrentSeatDisplay();
    }
  }

  // メッセージ表示更新
  function displayMessage(msg) {
    const el = document.get
// ========== 初期設定 ==========

const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

let currentSeat = null;        // 現在選択中の座席ID（例：table01）
let seatMap = {};              // { seatID: [playerID,...], ... }
let actionHistory = [];        // 直近の登録操作を記録して取り消しに使う
let lastScanTime = 0;          // 最終スキャン時刻（ミリ秒）
let isRankingMode = false;     // 順位登録モードかどうか

// プレイヤーデータ（必要に応じて拡張）
let players = JSON.parse(localStorage.getItem("players") || "{}");

// ========== 初期化処理 ==========

document.addEventListener("DOMContentLoaded", async () => {
  // ローカル保存から復元
  const savedMap = localStorage.getItem("seatMap");
  if (savedMap) {
    seatMap = JSON.parse(savedMap);
    displayMessage("📦 前回のデータを復元しました");
    updateTable();
  } else {
    // Google Driveからの復元も試みる
    await loadSeatMapFromDrive();
  }

  startQrCodeScanner();
  updateCompleteSeatBtn(false);
  updateRankingToggleButton();
  updateCurrentSeatDisplay();
});

// ========== QRコードスキャン開始 ==========

function startQrCodeScanner() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 15,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.33
    },
    onScanSuccess,
    onScanFailure
  ).catch(err => {
    console.error("カメラ起動エラー:", err);
    displayMessage("カメラ起動に失敗しました: " + err);
  });
}

// ========== スキャン失敗時（無視） ==========

function onScanFailure(error) {
  // 無視（特に表示なし）
}

// ========== スキャン成功時の処理 ==========

function onScanSuccess(decodedText) {
  const now = Date.now();
  // 2秒未満の連続読み取りを無視（誤検知防止）
  if (now - lastScanTime < 2000) return;
  lastScanTime = now;

  // QRコード形式チェック（"table"か"player"で始まるか）
  if (!/^(table|player)/.test(decodedText)) {
    displayMessage("❗不正なQRコードです。'table〜' または 'player〜' で始めてください。");
    return;
  }

  // 順位登録モード時の挙動
  if (isRankingMode) {
    if (decodedText.startsWith("table")) {
      if (!seatMap[decodedText]) {
        displayMessage(`⚠ 座席データが存在しません: ${decodedText}`);
        return;
      }
      showRankingSelection(decodedText);
    } else {
      displayMessage("⚠ 順位登録モードでは座席QRのみ読み取ってください。");
    }
    return;
  }

  // 通常モードの座席QR読み取り
  if (decodedText.startsWith("table")) {
    currentSeat = decodedText;
    if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
    displayMessage(`座席「${currentSeat}」を読み取りました。最大6人まで登録可能。`);
    updateCompleteSeatBtn(true);
    updateTable();
    updateCurrentSeatDisplay();
    return;
  }

  // 通常モードの生徒QR読み取り
  if (decodedText.startsWith("player")) {
    if (!currentSeat) {
      displayMessage("最初に座席QR（table〜）を読み取ってください。");
      return;
    }
    const people = seatMap[currentSeat];

    if (people.length >= 6) {
      displayMessage(`座席「${currentSeat}」は6人までです。登録を完了します。`);
      completeCurrentSeat();
      updateCurrentSeatDisplay();
      return;
    }

    if (people.includes(decodedText)) {
      displayMessage(`「${decodedText}」は既に座席「${currentSeat}」に登録されています。`);
      return;
    }

    // 登録
    people.push(decodedText);
    actionHistory.push({ seat: currentSeat, person: decodedText });
    displayMessage(`「${decodedText}」を座席「${currentSeat}」に登録（${people.length}/6）`);

    if (people.length >= 6) {
      displayMessage("上限に達しました。登録を完了します。");
      completeCurrentSeat();
    }

    updateTable();
    updateCurrentSeatDisplay();
  }
}

// ========== メッセージ表示 ==========

function displayMessage(msg) {
  const el = document.getElementById("result");
  if (el) el.innerText = msg;
}

// ========== 「登録完了」ボタンの表示切り替え ==========

function updateCompleteSeatBtn(show) {
  const btn = document.getElementById("completeSeatBtn");
  if (!btn) return;
  btn.style.display = show ? "inline-block" : "none";
}

// ========== 「順位登録モード切替」ボタン表示更新 ==========

function updateRankingToggleButton() {
  const btn = document.getElementById("toggleRankingBtn");
  if (!btn) return;
  btn.setAttribute("aria-pressed", isRankingMode.toString());
  btn.textContent = isRankingMode ? "📋 順位登録モードを終了" : "📋 順位登録モード切替";
}

// ========== 現在の座席表示更新 ==========

function updateCurrentSeatDisplay() {
  const el = document.getElementById("currentSeatText");
  if (!el) return;

  if (!currentSeat) {
    el.textContent = "未選択";
    el.style.color = "#666";
    el.style.fontWeight = "normal";
  } else {
    const peopleCount = seatMap[currentSeat]?.length || 0;
    el.textContent = `${currentSeat} （登録済み ${peopleCount} / 6 人）`;
    el.style.color = "#5d4037";
    el.style.fontWeight = "bold";
  }
}
// ========== 座席一覧表示更新 ==========

function updateTable() {
  const listEl = document.getElementById("seatList");
  if (!listEl) return;

  listEl.innerHTML = ""; // いったんクリア

  // seatMapの全座席を表示
  for (const seatId of Object.keys(seatMap).sort()) {
    const playersInSeat = seatMap[seatId];

    const li = document.createElement("li");
    li.className = "seat-item";
    li.dataset.seatid = seatId;

    const title = document.createElement("strong");
    title.textContent = seatId + "：";
    li.appendChild(title);

    // 登録されたプレイヤー一覧表示
    const namesSpan = document.createElement("span");
    namesSpan.className = "player-names";
    namesSpan.textContent = playersInSeat.length
      ? playersInSeat.join(", ")
      : "（未登録）";
    li.appendChild(namesSpan);

    // 取消ボタン（1つずつ取り消し）
    if (playersInSeat.length > 0) {
      const undoBtn = document.createElement("button");
      undoBtn.textContent = "取消";
      undoBtn.className = "undo-btn";
      undoBtn.addEventListener("click", () => {
        undoLastRegistration(seatId);
      });
      li.appendChild(undoBtn);
    }

    // 削除ボタン（座席まるごと削除）
    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.className = "delete-btn";
    delBtn.addEventListener("click", () => {
      if (confirm(`座席「${seatId}」の登録をすべて削除してよいですか？`)) {
        deleteSeat(seatId);
      }
    });
    li.appendChild(delBtn);

    listEl.appendChild(li);
  }
}

// ========== 登録取消（最後に追加した人を取り消す） ==========

function undoLastRegistration(seatId) {
  // actionHistoryから対象のseatId最後の登録を探す
  for (let i = actionHistory.length - 1; i >= 0; i--) {
    const action = actionHistory[i];
    if (action.seat === seatId) {
      // 登録解除
      const idx = seatMap[seatId].indexOf(action.person);
      if (idx !== -1) {
        seatMap[seatId].splice(idx, 1);
        actionHistory.splice(i, 1);
        displayMessage(`座席「${seatId}」の「${action.person}」登録を取り消しました。`);
        saveSeatMapLocal();
        updateTable();
        updateCurrentSeatDisplay();
        updateCompleteSeatBtn(true);
      }
      return;
    }
  }
  displayMessage(`座席「${seatId}」に取り消せる登録がありません。`);
}

// ========== 座席登録削除（座席ごと消す） ==========

function deleteSeat(seatId) {
  if (!seatMap[seatId]) return;
  delete seatMap[seatId];

  // actionHistoryからも該当seatIdの履歴を削除
  actionHistory = actionHistory.filter(a => a.seat !== seatId);

  displayMessage(`座席「${seatId}」の登録をすべて削除しました。`);
  if (seatId === currentSeat) {
    currentSeat = null;
    updateCompleteSeatBtn(false);
    updateCurrentSeatDisplay();
  }
  saveSeatMapLocal();
  updateTable();
}

// ========== 座席登録完了処理 ==========

function completeCurrentSeat() {
  if (!currentSeat) return;

  // 6人未満でも登録完了を許可
  displayMessage(`座席「${currentSeat}」の登録を完了しました。`);
  currentSeat = null;

  updateCompleteSeatBtn(false);
  updateCurrentSeatDisplay();

  saveSeatMapLocal();

  // ここでGoogle Drive保存を呼び出し（非同期）
  saveSeatMapToDrive();
}

// ========== ローカルストレージに保存 ==========

function saveSeatMapLocal() {
  localStorage.setItem("seatMap", JSON.stringify(seatMap));
}

// ========== Google Driveへ保存呼び出し ==========

async function saveSeatMapToDrive() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ command: "saveSeatMap", data: seatMap }),
      headers: { "Content-Type": "application/json" }
    });
    const json = await res.json();
    if (json.result === "success") {
      displayMessage("✅ Google Driveに保存しました。");
    } else {
      displayMessage("⚠ Google Driveへの保存に失敗しました。");
    }
  } catch (e) {
    displayMessage("⚠ Google Drive保存中にエラーが発生しました。");
    console.error(e);
  }
}

// ========== Google Driveからの読み込み（初期化時） ==========

async function loadSeatMapFromDrive() {
  try {
    const res = await fetch(API_URL + "?command=loadSeatMap");
    const json = await res.json();
    if (json.result === "success" && json.data) {
      seatMap = json.data;
      displayMessage("📥 Google Driveから座席データを読み込みました。");
      updateTable();
      saveSeatMapLocal(); // ローカルにも保存
    } else {
      displayMessage("ℹ Google Driveに座席データはありません。");
    }
  } catch (e) {
    displayMessage("⚠ Google Driveからの読み込みに失敗しました。");
    console.error(e);
  }
}
// ========== 順位登録モード：プレイヤー読み取りと登録 ==========

let rankingList = [];  // 登録されたplayerIDの配列

function handlePlayerForRanking(playerId) {
  if (!playerId.startsWith("player-")) {
    displayMessage("⚠ 順位登録モードでは player- のQRコードを読み取ってください。");
    return;
  }

  if (rankingList.includes(playerId)) {
    displayMessage(`⚠ ${playerMap[playerId]?.name || playerId} はすでに登録済みです。`);
    return;
  }

  rankingList.push(playerId);
  displayMessage(`${playerMap[playerId]?.name || playerId} を順位リストに追加しました。`);
  updateRankingUI();
}

// ========== 順位登録UI更新（並び替え可能リスト） ==========

function updateRankingUI() {
  const rankingListEl = document.getElementById("rankingList");
  if (!rankingListEl) return;
  rankingListEl.innerHTML = "";

  rankingList.forEach((id, idx) => {
    const li = document.createElement("li");
    li.className = "ranking-item";
    li.draggable = true;
    li.dataset.playerId = id;
    li.textContent = `${idx + 1}. ${playerMap[id]?.name || id}`;
    rankingListEl.appendChild(li);
  });

  makeRankingSortable();
}

// ========== 並び替え可能にする（PCとスマホ対応） ==========

function makeRankingSortable() {
  const list = document.getElementById("rankingList");
  let dragged;

  list.querySelectorAll("li").forEach(li => {
    // PC用
    li.addEventListener("dragstart", e => {
      dragged = li;
      li.style.opacity = 0.5;
    });

    li.addEventListener("dragend", () => {
      dragged.style.opacity = "";
    });

    li.addEventListener("dragover", e => {
      e.preventDefault();
    });

    li.addEventListener("drop", e => {
      e.preventDefault();
      if (dragged && dragged !== li) {
        const draggedId = dragged.dataset.playerId;
        const targetId = li.dataset.playerId;

        const fromIdx = rankingList.indexOf(draggedId);
        const toIdx = rankingList.indexOf(targetId);

        rankingList.splice(fromIdx, 1);
        rankingList.splice(toIdx, 0, draggedId);

        updateRankingUI();
      }
    });

    // スマホ用
    li.addEventListener("touchstart", e => {
      dragged = li;
      dragged.classList.add("dragged");
    });

    li.addEventListener("touchend", e => {
      dragged?.classList.remove("dragged");
      dragged = null;
    });

    li.addEventListener("touchmove", e => {
      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (dragged && target && target.closest && target.closest("li")) {
        const overLi = target.closest("li");
        const draggedId = dragged.dataset.playerId;
        const overId = overLi.dataset.playerId;

        if (draggedId !== overId) {
          const fromIdx = rankingList.indexOf(draggedId);
          const toIdx = rankingList.indexOf(overId);

          rankingList.splice(fromIdx, 1);
          rankingList.splice(toIdx, 0, draggedId);
          updateRankingUI();
        }
      }
    });
  });
}

// ========== 順位確定ボタン押下時処理 ==========

function confirmRanking() {
  if (rankingList.length === 0) {
    displayMessage("⚠ 順位が登録されていません。");
    return;
  }

  if (!confirm("この順位で確定してレートを更新しますか？")) return;

  applyRankingAndCalculateRating(rankingList);
  displayMessage("✅ 順位を確定しました。レートを更新しました。");

  rankingList = [];
  updateRankingUI();
  updateRateTable();
}

// ========== レート計算ロジックの例（自由に拡張可能） ==========

function applyRankingAndCalculateRating(list) {
  const n = list.length;

  list.forEach((playerId, idx) => {
    const player = playerMap[playerId];
    if (!player) return;

    const prevRate = player.rate || 50;
    let bonus = 0;

    // 単純な例：1位 +5, 2位 +2, 3位±0, 以下 -3
    if (idx === 0) bonus = 5;
    else if (idx === 1) bonus = 2;
    else if (idx === 2) bonus = 0;
    else bonus = -3;

    // 上限・下限補正
    let newRate = Math.max(30, Math.min(99, prevRate + bonus));

    // 保存
    player.prevRate = prevRate;
    player.rate = newRate;
    player.lastRank = idx + 1;
    player.bonus = bonus;
  });

  savePlayerMapLocal();
}

// ========== プレイヤー情報のローカル保存 ==========

function savePlayerMapLocal() {
  localStorage.setItem("playerMap", JSON.stringify(playerMap));
}

// ========== レート表UI更新 ==========

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0
    };
  });

  // レート順にソート
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>順位</th><th>名前</th><th>レート</th><th>前回順位</th><th>変動</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
    `;
    table.appendChild(tr);
  });
}
// ========== CSVエクスポート ==========

function exportCSV() {
  const header = ["名前", "レート", "前回順位", "変動", "称号"];
  const rows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p) || ""
  ]);

  const csvContent = [header, ...rows].map(row =>
    row.map(val => `"${val}"`).join(",")
  ).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "rate_result.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // レート順に並び替え
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>順位</th><th>名前</th><th>レート</th><th>前回順位</th><th>変動</th><th>称号</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.title}</td>
    `;
    table.appendChild(tr);
  });
}

// ========== Google Drive 連携保存（失敗時はローカル保存） ==========

async function saveToGoogleDrive(filename, data) {
  if (!window.gapi || !gapi.auth2) {
    console.warn("Google API 未ロードのためローカル保存に切り替えます。");
    saveToLocalFallback(filename, data);
    return;
  }

  try {
    const authInstance = gapi.auth2.getAuthInstance();
    if (!authInstance.isSignedIn.get()) {
      await authInstance.signIn();
    }

    const fileContent = new Blob([data], { type: 'text/plain' });
    const metadata = {
      name: filename,
      mimeType: 'text/plain'
    };

    const accessToken = gapi.auth.getToken().access_token;

    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", fileContent);

    const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: new Headers({ Authorization: "Bearer " + accessToken }),
      body: form
    });

    if (res.ok) {
      displayMessage("✅ Google Drive に保存しました。");
    } else {
      console.warn("Drive保存失敗、ローカルへフォールバックします。");
      saveToLocalFallback(filename, data);
    }
  } catch (e) {
    console.error("Drive連携エラー", e);
    saveToLocalFallback(filename, data);
  }
}

function saveToLocalFallback(filename, data) {
  const blob = new Blob([data], { type: "text/plain;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  displayMessage("💾 ローカルに保存しました。");
}

// ========== 保存ボタン連携処理（CSV＋Drive） ==========

function saveAllData() {
  const csvHeader = ["名前", "レート", "前回順位", "変動", "称号"];
  const csvRows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p)
  ]);

  const csvContent = [csvHeader, ...csvRows].map(r =>
    r.map(cell => `"${cell}"`).join(",")
  ).join("\n");

  saveToGoogleDrive("rate_result.csv", csvContent);
}

// ========== 汎用メッセージ表示（HTML側に #messageBox が必要） ==========

function displayMessage(text) {
  const msgEl = document.getElementById("messageBox");
  if (msgEl) {
    msgEl.textContent = text;
    msgEl.style.opacity = 1;
    setTimeout(() => msgEl.style.opacity = 0, 4000);
  } else {
    alert(text);
  }
}
// ========== ポップアップ演出 ==========

function showPopup(text, color = "gold") {
  const popup = document.createElement("div");
  popup.textContent = text;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.padding = "1em 2em";
  popup.style.backgroundColor = color;
  popup.style.color = "#000";
  popup.style.fontSize = "24px";
  popup.style.fontWeight = "bold";
  popup.style.borderRadius = "12px";
  popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  popup.style.zIndex = "9999";
  popup.style.opacity = 1;
  document.body.appendChild(popup);

  setTimeout(() => {
    popup.style.transition = "opacity 1s ease, transform 1s ease";
    popup.style.opacity = 0;
    popup.style.transform = "translate(-50%, -70%)";
  }, 800);

  setTimeout(() => {
    popup.remove();
  }, 1800);
}

// ========== 順位変動の表示ロジック ==========

function updateRateTableWithDiff() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank ?? null,
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // レート順に並び替え
  rows.sort((a, b) => b.rate - a.rate);

  // 順位を記録
  rows.forEach((row, index) => {
    const currentRank = index + 1;
    const player = playerMap[row.id];

    // 順位変動チェック
    if (player.lastShownRank && player.lastShownRank !== currentRank) {
      const diff = player.lastShownRank - currentRank;
      const symbol = diff > 0 ? "↑" : "↓";
      const movement = Math.abs(diff);
      row.rankDiff = `${symbol}${movement}`;
    } else {
      row.rankDiff = "-";
    }

    // 次回比較用に保存
    player.lastShownRank = currentRank;
  });

  // 表更新
  table.innerHTML = `
    <tr><th>順位</th><th>名前</th><th>レート</th><th>前回順位</th><th>変動</th><th>変動差</th><th>称号</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    const bonusColor = row.bonus > 0 ? "limegreen" : row.bonus < 0 ? "tomato" : "#444";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank ?? "-"}</td>
      <td style="color:${bonusColor}">${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.rankDiff || "-"}</td>
      <td>${row.title}</td>
    `;

    // 強調アニメーション（新しいデータに反応）
    if (row.bonus !== 0) {
      tr.style.animation = "flash 0.8s";
    }

    table.appendChild(tr);
  });
}

// ========== 強調アニメーションCSSの追加（1回限り） ==========

(function addFlashAnimationOnce() {
  const styleId = "flash-css-style";
  if (document.getElementById(styleId)) return;

  const style = document.createElement("style");
  style.id = styleId;
  style.textContent = `
    @keyframes flash {
      0% { background-color: yellow; }
      100% { background-color: inherit; }
    }
    tr[style*="animation: flash"] {
      transition: background-color 1s;
    }
  `;
  document.head.appendChild(style);
})();
    
window.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("rankingTable");
  const rawData = localStorage.getItem("players");

  if (!rawData) {
    table.innerHTML = "<tr><td colspan='6'>データがありません</td></tr>";
    return;
  }

  const players = JSON.parse(rawData);
  const rows = Object.entries(players).map(([id, p]) => {
    return {
      name: p.name,
      rate: p.rate ?? 50,
      lastRank: p.lastRank ?? "-",
      bonus: p.bonus ?? 0,
      title: getTitle(p)
    };
  });

  // レート降順でソート
  rows.sort((a, b) => b.rate - a.rate);

  // 表描画
  table.innerHTML = `
    <tr><th>順位</th><th>名前</th><th>レート</th><th>前回順位</th><th>変動</th><th>称号</th></tr>
  `;

  rows.forEach((p, i) => {
    const tr = document.createElement("tr");
    const bonusColor = p.bonus > 0 ? "limegreen" : p.bonus < 0 ? "tomato" : "#444";
    const diff = p.lastRank === "-" ? "-" : `${p.lastRank - (i + 1)}`;
    const diffSymbol = diff > 0 ? `↑${Math.abs(diff)}` : diff < 0 ? `↓${Math.abs(diff)}` : "-";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rate}</td>
      <td>${p.lastRank}</td>
      <td style="color:${bonusColor}">${p.bonus >= 0 ? "+" : ""}${p.bonus}</td>
      <td>${p.title}</td>
    `;

    table.appendChild(tr);
  });
});

// ランクに応じた称号生成（共通関数）
function getTitle(player) {
  const rate = player.rate ?? 50;
  if (rate >= 100) return "伝説";
  if (rate >= 90) return "神";
  if (rate >= 80) return "覇者";
  if (rate >= 70) return "猛者";
  if (rate >= 60) return "常連";
  if (rate >= 50) return "一般";
  if (rate >= 40) return "初心者";
  return "修行中";
}

</body>
</html>
