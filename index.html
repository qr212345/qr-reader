<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com;">
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  img-src 'self' data: blob: https://fonts.gstatic.com;
  style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
">
<title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆå‰Šé™¤ï¼†é †ä½ç™»éŒ²æ©Ÿèƒ½ä»˜ãï¼‰</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f4f8;
    color: #333;
    margin: 0; padding: 1rem; text-align: center;
    overflow-x: hidden;
  }
  h1 {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
  }
  #currentSeatDisplay {
    margin: 1rem auto;
    font-size: 1.3rem;
    font-weight: bold;
    max-width: 480px;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background-color: #ffe082; /* æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    color: #5d4037;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #result {
    font-weight: bold;
    background-color: #e0f7fa;
    padding: 0.8rem 1rem;
    margin: 0 auto 1.5rem;
    max-width: 480px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 3rem;
  }
  .button-group {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    max-width: 320px;
    margin: 1rem auto 3rem;
  }
  button {
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  button:hover {
    background-color: #43a047;
  }
  button:active {
    transform: scale(0.97);
  }
  #completeSeatBtn {
    background-color: #ff9800;
    display: none;
  }
  #completeSeatBtn:hover {
    background-color: #fb8c00;
  }
  table {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
    border-collapse: collapse;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  th {
    background-color: #4caf50;
    color: white;
    padding: 10px;
    text-align: left;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  .student {
    display: inline-block;
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 16px;
    margin: 4px 6px 4px 0;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .student:hover {
    background-color: #bbdefb;
  }
  .seat {
    cursor: pointer;
    color: #d32f2f;
    font-weight: bold;
    user-select: none;
    transition: color 0.3s ease;
  }
  .seat:hover {
    color: #b71c1c;
    text-decoration: underline;
  }
  #seatTable tbody tr:hover {
    background-color: #e8f5e9;
  }
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é †ä½ç™»éŒ²UI */
  #ranking-select-ui {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    padding: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #ranking-select-ui h3 {
    margin-top: 0;
  }
  #sortable-player-list {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  #sortable-player-list li {
    padding: 8px;
    margin: 4px 0;
    background: #e3f2fd;
    border-radius: 4px;
    cursor: move;
    user-select: none;
  }
  #sortable-player-list li.dragging {
    opacity: 0.5;
  }
  /* ç§°å·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .title.top1 {
    background: linear-gradient(45deg, #f9d71c, #ffec4f, #f9d71c);
    animation: lightningGlow 1.5s infinite alternate;
    box-shadow: 0 0 8px 3px #f9d71c;
  }
  @keyframes lightningGlow {
    0% { filter: drop-shadow(0 0 5px #ffeb3b); opacity: 0.8; }
    100% { filter: drop-shadow(0 0 20px #ffeb3b); opacity: 1; }
  }
  .title.top2 {
    background: linear-gradient(90deg, #2196f3, #64b5f6, #2196f3);
    animation: waveGlow 3s infinite linear;
    box-shadow: 0 0 10px 2px #2196f3;
  }
  @keyframes waveGlow {
    0% { background-position: 0% 50%; box-shadow: 0 0 8px 2px #2196f3; }
    50% { background-position: 100% 50%; box-shadow: 0 0 15px 4px #64b5f6; }
    100% { background-position: 0% 50%; box-shadow: 0 0 8px 2px #2196f3; }
  }
  .title.top3 {
    background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
    animation: windGlow 4s infinite ease-in-out alternate;
    box-shadow: 0 0 6px 2px #81d4fa;
    color: #0277bd;
  }
  @keyframes windGlow {
    0% {
      text-shadow: 0 0 5px #b2ebf2;
      box-shadow: 0 0 6px 2px #81d4fa;
      opacity: 0.8;
    }
    100% {
      text-shadow: 0 0 15px #e0f7fa;
      box-shadow: 0 0 12px 4px #4fc3f7;
      opacity: 1;
    }
  }
  .title.last {
    background: linear-gradient(45deg, #440000, #880000, #440000);
    color: #ff4444;
    animation: deathGlow 2s infinite alternate;
    box-shadow: 0 0 10px 3px #880000;
  }
  @keyframes deathGlow {
    from {
      filter: drop-shadow(0 0 5px #ff0000);
      opacity: 0.7;
    }
    to {
      filter: drop-shadow(0 0 15px #ff0000);
      opacity: 1;
    }
  }
</style>
</head>
<body>

<h1>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h1>
<p>åº§å¸­ï¼ˆtableã€œï¼‰â†’ ç”Ÿå¾’ï¼ˆplayerã€œï¼‰ã®é †ã«èª­ã¿å–ã‚Šã€‚6äººã¾ã§ç™»éŒ²ã€‚ç”Ÿå¾’IDã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤å¯èƒ½ã€‚</p>

<!-- ç¾åœ¨ã®åº§å¸­é¸æŠçŠ¶æ³è¡¨ç¤º -->
<div id="currentSeatDisplay" aria-live="polite" role="region" aria-label="ç¾åœ¨ã®åº§å¸­é¸æŠçŠ¶æ³">
  ç¾åœ¨ã®åº§å¸­: <span id="currentSeatText">æœªé¸æŠ</span>
</div>

<!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šé ˜åŸŸ -->
<div id="reader-wrapper"><div id="reader"></div></div>

<!-- èª­ã¿å–ã‚Šçµæœè¡¨ç¤º -->
<div id="result" aria-live="polite" role="status">ã“ã“ã«èª­ã¿å–ã‚ŠçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>

<!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
<div class="button-group" role="group" aria-label="æ“ä½œãƒœã‚¿ãƒ³ç¾¤">
  <button onclick="downloadCSV()" aria-label="CSVã§ä¿å­˜">CSVã§ä¿å­˜</button>
  <button id="completeSeatBtn" onclick="completeCurrentSeat()" aria-label="ç¾åœ¨ã®åº§å¸­ç™»éŒ²å®Œäº†ãƒœã‚¿ãƒ³">ã“ã®åº§å¸­ã®ç™»éŒ²ã‚’å®Œäº†</button>
  <button onclick="undoLast()" aria-label="æœ€å¾Œã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã™">æœ€å¾Œã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã™</button>
  <button onclick="clearSavedData()" aria-label="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
  <button onclick="saveSeatMapToDrive()" aria-label="Google Driveã«ä¿å­˜">ğŸ’¾ Google Driveã«ä¿å­˜</button>
  <button onclick="loadSeatMapFromDrive()" aria-label="Driveã‹ã‚‰å¾©å…ƒ">â˜ Driveã‹ã‚‰å¾©å…ƒ</button>
  <button onclick="toggleRankingMode()" aria-pressed="false" id="toggleRankingBtn">ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
</div>

<!-- åº§å¸­ã¨ç”Ÿå¾’ã®ç™»éŒ²çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ« -->
<section class="footer-area" aria-label="ç¾åœ¨ã®åº§å¸­ç™»éŒ²çŠ¶æ³">
  <h2>ç¾åœ¨ã®åº§å¸­ç™»éŒ²</h2>
  <table id="seatTable" role="table" aria-describedby="tableDesc">
    <caption id="tableDesc">åº§å¸­IDã¨ç”Ÿå¾’IDä¸€è¦§ãŠã‚ˆã³é †ä½</caption>
    <thead>
      <tr><th scope="col">åº§å¸­ID</th><th scope="col">ç”Ÿå¾’IDä¸€è¦§</th><th scope="col">é †ä½</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
<script>
  // Google Apps Script API URLï¼ˆDriveé€£æºç”¨ï¼‰
  const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

  let currentSeat = null;   // ç¾åœ¨ç™»éŒ²ä¸­ã®åº§å¸­ID
  let seatMap = {};        // { seatID: [playerID, ...] }
  let actionHistory = [];  // æ“ä½œå±¥æ­´ï¼ˆundoç”¨ï¼‰
  let lastScanTime = 0;    // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ç”¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  let isRankingMode = false;  // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

  // äº‹å‰ã«localStorageã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆä»»æ„ã€åˆæœŸã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  let players = JSON.parse(localStorage.getItem("players") || "{}");

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã€QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹
  document.addEventListener("DOMContentLoaded", async () => {
    const savedMap = localStorage.getItem("seatMap");
    if (savedMap) {
      seatMap = JSON.parse(savedMap);
      displayMessage("ğŸ“¦ å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
      updateTable();
    } else {
      await loadSeatMapFromDrive();
    }

    startQrCodeScanner();
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
    updateCurrentSeatDisplay();
  });

  // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•
  function startQrCodeScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.33
      },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
      displayMessage("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
    });
  }

  // èª­ã¿å–ã‚Šå¤±æ•—æ™‚ï¼ˆç‰¹ã«ç„¡è¦–ï¼‰
  function onScanFailure(error) {
    // noop
  }

  // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return; // 2ç§’ä»¥å†…é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
    lastScanTime = now;

    // å½¢å¼ãƒã‚§ãƒƒã‚¯
    if (!/^(table|player)/.test(decodedText)) {
      displayMessage("â—ä¸æ­£ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚'tableã€œ' ã¾ãŸã¯ 'playerã€œ' ã§å§‹ã‚ã¦ãã ã•ã„ã€‚");
      return;
    }

    if (isRankingMode) {
      if (decodedText.startsWith("table")) {
        if (!seatMap[decodedText]) {
          displayMessage(`âš  åº§å¸­ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${decodedText}`);
          return;
        }
        showRankingSelection(decodedText);
      } else {
        displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº§å¸­QRã®ã¿èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
      }
      return;
    }

    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
    if (decodedText.startsWith("table")) {
      currentSeat = decodedText;
      if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
      displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚æœ€å¤§6äººã¾ã§ç™»éŒ²å¯èƒ½ã€‚`);
      updateCompleteSeatBtn(true);
      updateTable();
      updateCurrentSeatDisplay();
      return;
    }

    if (decodedText.startsWith("player")) {
      if (!currentSeat) {
        displayMessage("æœ€åˆã«åº§å¸­QRï¼ˆtableã€œï¼‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
        return;
      }
      const people = seatMap[currentSeat];
      if (people.length >= 6) {
        displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã¯6äººã¾ã§ã§ã™ã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚`);
        completeCurrentSeat();
        updateCurrentSeatDisplay();
        return;
      }
      if (people.includes(decodedText)) {
        displayMessage(`ã€Œ${decodedText}ã€ã¯æ—¢ã«åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
        return;
      }
      people.push(decodedText);
      actionHistory.push({ seat: currentSeat, person: decodedText });
      displayMessage(`ã€Œ${decodedText}ã€ã‚’åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ï¼ˆ${people.length}/6ï¼‰`);
      if (people.length >= 6) {
        displayMessage("ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚");
        completeCurrentSeat();
      }
      updateTable();
      updateCurrentSeatDisplay();
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ›´æ–°
  function displayMessage(msg) {
    const el = document.get
// ========== åˆæœŸè¨­å®š ==========

const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

let currentSeat = null;        // ç¾åœ¨é¸æŠä¸­ã®åº§å¸­IDï¼ˆä¾‹ï¼štable01ï¼‰
let seatMap = {};              // { seatID: [playerID,...], ... }
let actionHistory = [];        // ç›´è¿‘ã®ç™»éŒ²æ“ä½œã‚’è¨˜éŒ²ã—ã¦å–ã‚Šæ¶ˆã—ã«ä½¿ã†
let lastScanTime = 0;          // æœ€çµ‚ã‚¹ã‚­ãƒ£ãƒ³æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
let isRankingMode = false;     // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
let players = JSON.parse(localStorage.getItem("players") || "{}");

// ========== åˆæœŸåŒ–å‡¦ç† ==========

document.addEventListener("DOMContentLoaded", async () => {
  // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‹ã‚‰å¾©å…ƒ
  const savedMap = localStorage.getItem("seatMap");
  if (savedMap) {
    seatMap = JSON.parse(savedMap);
    displayMessage("ğŸ“¦ å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
    updateTable();
  } else {
    // Google Driveã‹ã‚‰ã®å¾©å…ƒã‚‚è©¦ã¿ã‚‹
    await loadSeatMapFromDrive();
  }

  startQrCodeScanner();
  updateCompleteSeatBtn(false);
  updateRankingToggleButton();
  updateCurrentSeatDisplay();
});

// ========== QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ==========

function startQrCodeScanner() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 15,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.33
    },
    onScanSuccess,
    onScanFailure
  ).catch(err => {
    console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
    displayMessage("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
  });
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—æ™‚ï¼ˆç„¡è¦–ï¼‰ ==========

function onScanFailure(error) {
  // ç„¡è¦–ï¼ˆç‰¹ã«è¡¨ç¤ºãªã—ï¼‰
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®å‡¦ç† ==========

function onScanSuccess(decodedText) {
  const now = Date.now();
  // 2ç§’æœªæº€ã®é€£ç¶šèª­ã¿å–ã‚Šã‚’ç„¡è¦–ï¼ˆèª¤æ¤œçŸ¥é˜²æ­¢ï¼‰
  if (now - lastScanTime < 2000) return;
  lastScanTime = now;

  // QRã‚³ãƒ¼ãƒ‰å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆ"table"ã‹"player"ã§å§‹ã¾ã‚‹ã‹ï¼‰
  if (!/^(table|player)/.test(decodedText)) {
    displayMessage("â—ä¸æ­£ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚'tableã€œ' ã¾ãŸã¯ 'playerã€œ' ã§å§‹ã‚ã¦ãã ã•ã„ã€‚");
    return;
  }

  // é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰æ™‚ã®æŒ™å‹•
  if (isRankingMode) {
    if (decodedText.startsWith("table")) {
      if (!seatMap[decodedText]) {
        displayMessage(`âš  åº§å¸­ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${decodedText}`);
        return;
      }
      showRankingSelection(decodedText);
    } else {
      displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº§å¸­QRã®ã¿èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
    }
    return;
  }

  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®åº§å¸­QRèª­ã¿å–ã‚Š
  if (decodedText.startsWith("table")) {
    currentSeat = decodedText;
    if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
    displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚æœ€å¤§6äººã¾ã§ç™»éŒ²å¯èƒ½ã€‚`);
    updateCompleteSeatBtn(true);
    updateTable();
    updateCurrentSeatDisplay();
    return;
  }

  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ç”Ÿå¾’QRèª­ã¿å–ã‚Š
  if (decodedText.startsWith("player")) {
    if (!currentSeat) {
      displayMessage("æœ€åˆã«åº§å¸­QRï¼ˆtableã€œï¼‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
      return;
    }
    const people = seatMap[currentSeat];

    if (people.length >= 6) {
      displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã¯6äººã¾ã§ã§ã™ã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚`);
      completeCurrentSeat();
      updateCurrentSeatDisplay();
      return;
    }

    if (people.includes(decodedText)) {
      displayMessage(`ã€Œ${decodedText}ã€ã¯æ—¢ã«åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
      return;
    }

    // ç™»éŒ²
    people.push(decodedText);
    actionHistory.push({ seat: currentSeat, person: decodedText });
    displayMessage(`ã€Œ${decodedText}ã€ã‚’åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ï¼ˆ${people.length}/6ï¼‰`);

    if (people.length >= 6) {
      displayMessage("ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚");
      completeCurrentSeat();
    }

    updateTable();
    updateCurrentSeatDisplay();
  }
}

// ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ==========

function displayMessage(msg) {
  const el = document.getElementById("result");
  if (el) el.innerText = msg;
}

// ========== ã€Œç™»éŒ²å®Œäº†ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ==========

function updateCompleteSeatBtn(show) {
  const btn = document.getElementById("completeSeatBtn");
  if (!btn) return;
  btn.style.display = show ? "inline-block" : "none";
}

// ========== ã€Œé †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–° ==========

function updateRankingToggleButton() {
  const btn = document.getElementById("toggleRankingBtn");
  if (!btn) return;
  btn.setAttribute("aria-pressed", isRankingMode.toString());
  btn.textContent = isRankingMode ? "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†" : "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿";
}

// ========== ç¾åœ¨ã®åº§å¸­è¡¨ç¤ºæ›´æ–° ==========

function updateCurrentSeatDisplay() {
  const el = document.getElementById("currentSeatText");
  if (!el) return;

  if (!currentSeat) {
    el.textContent = "æœªé¸æŠ";
    el.style.color = "#666";
    el.style.fontWeight = "normal";
  } else {
    const peopleCount = seatMap[currentSeat]?.length || 0;
    el.textContent = `${currentSeat} ï¼ˆç™»éŒ²æ¸ˆã¿ ${peopleCount} / 6 äººï¼‰`;
    el.style.color = "#5d4037";
    el.style.fontWeight = "bold";
  }
}
// ========== åº§å¸­ä¸€è¦§è¡¨ç¤ºæ›´æ–° ==========

function updateTable() {
  const listEl = document.getElementById("seatList");
  if (!listEl) return;

  listEl.innerHTML = ""; // ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢

  // seatMapã®å…¨åº§å¸­ã‚’è¡¨ç¤º
  for (const seatId of Object.keys(seatMap).sort()) {
    const playersInSeat = seatMap[seatId];

    const li = document.createElement("li");
    li.className = "seat-item";
    li.dataset.seatid = seatId;

    const title = document.createElement("strong");
    title.textContent = seatId + "ï¼š";
    li.appendChild(title);

    // ç™»éŒ²ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º
    const namesSpan = document.createElement("span");
    namesSpan.className = "player-names";
    namesSpan.textContent = playersInSeat.length
      ? playersInSeat.join(", ")
      : "ï¼ˆæœªç™»éŒ²ï¼‰";
    li.appendChild(namesSpan);

    // å–æ¶ˆãƒœã‚¿ãƒ³ï¼ˆ1ã¤ãšã¤å–ã‚Šæ¶ˆã—ï¼‰
    if (playersInSeat.length > 0) {
      const undoBtn = document.createElement("button");
      undoBtn.textContent = "å–æ¶ˆ";
      undoBtn.className = "undo-btn";
      undoBtn.addEventListener("click", () => {
        undoLastRegistration(seatId);
      });
      li.appendChild(undoBtn);
    }

    // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆåº§å¸­ã¾ã‚‹ã”ã¨å‰Šé™¤ï¼‰
    const delBtn = document.createElement("button");
    delBtn.textContent = "å‰Šé™¤";
    delBtn.className = "delete-btn";
    delBtn.addEventListener("click", () => {
      if (confirm(`åº§å¸­ã€Œ${seatId}ã€ã®ç™»éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚ˆã„ã§ã™ã‹ï¼Ÿ`)) {
        deleteSeat(seatId);
      }
    });
    li.appendChild(delBtn);

    listEl.appendChild(li);
  }
}

// ========== ç™»éŒ²å–æ¶ˆï¼ˆæœ€å¾Œã«è¿½åŠ ã—ãŸäººã‚’å–ã‚Šæ¶ˆã™ï¼‰ ==========

function undoLastRegistration(seatId) {
  // actionHistoryã‹ã‚‰å¯¾è±¡ã®seatIdæœ€å¾Œã®ç™»éŒ²ã‚’æ¢ã™
  for (let i = actionHistory.length - 1; i >= 0; i--) {
    const action = actionHistory[i];
    if (action.seat === seatId) {
      // ç™»éŒ²è§£é™¤
      const idx = seatMap[seatId].indexOf(action.person);
      if (idx !== -1) {
        seatMap[seatId].splice(idx, 1);
        actionHistory.splice(i, 1);
        displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã®ã€Œ${action.person}ã€ç™»éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚`);
        saveSeatMapLocal();
        updateTable();
        updateCurrentSeatDisplay();
        updateCompleteSeatBtn(true);
      }
      return;
    }
  }
  displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã«å–ã‚Šæ¶ˆã›ã‚‹ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
}

// ========== åº§å¸­ç™»éŒ²å‰Šé™¤ï¼ˆåº§å¸­ã”ã¨æ¶ˆã™ï¼‰ ==========

function deleteSeat(seatId) {
  if (!seatMap[seatId]) return;
  delete seatMap[seatId];

  // actionHistoryã‹ã‚‰ã‚‚è©²å½“seatIdã®å±¥æ­´ã‚’å‰Šé™¤
  actionHistory = actionHistory.filter(a => a.seat !== seatId);

  displayMessage(`åº§å¸­ã€Œ${seatId}ã€ã®ç™»éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
  if (seatId === currentSeat) {
    currentSeat = null;
    updateCompleteSeatBtn(false);
    updateCurrentSeatDisplay();
  }
  saveSeatMapLocal();
  updateTable();
}

// ========== åº§å¸­ç™»éŒ²å®Œäº†å‡¦ç† ==========

function completeCurrentSeat() {
  if (!currentSeat) return;

  // 6äººæœªæº€ã§ã‚‚ç™»éŒ²å®Œäº†ã‚’è¨±å¯
  displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚`);
  currentSeat = null;

  updateCompleteSeatBtn(false);
  updateCurrentSeatDisplay();

  saveSeatMapLocal();

  // ã“ã“ã§Google Driveä¿å­˜ã‚’å‘¼ã³å‡ºã—ï¼ˆéåŒæœŸï¼‰
  saveSeatMapToDrive();
}

// ========== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ ==========

function saveSeatMapLocal() {
  localStorage.setItem("seatMap", JSON.stringify(seatMap));
}

// ========== Google Driveã¸ä¿å­˜å‘¼ã³å‡ºã— ==========

async function saveSeatMapToDrive() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ command: "saveSeatMap", data: seatMap }),
      headers: { "Content-Type": "application/json" }
    });
    const json = await res.json();
    if (json.result === "success") {
      displayMessage("âœ… Google Driveã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
    } else {
      displayMessage("âš  Google Driveã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  } catch (e) {
    displayMessage("âš  Google Driveä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    console.error(e);
  }
}

// ========== Google Driveã‹ã‚‰ã®èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸåŒ–æ™‚ï¼‰ ==========

async function loadSeatMapFromDrive() {
  try {
    const res = await fetch(API_URL + "?command=loadSeatMap");
    const json = await res.json();
    if (json.result === "success" && json.data) {
      seatMap = json.data;
      displayMessage("ğŸ“¥ Google Driveã‹ã‚‰åº§å¸­ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
      updateTable();
      saveSeatMapLocal(); // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
    } else {
      displayMessage("â„¹ Google Driveã«åº§å¸­ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
  } catch (e) {
    displayMessage("âš  Google Driveã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    console.error(e);
  }
}
// ========== é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿å–ã‚Šã¨ç™»éŒ² ==========

let rankingList = [];  // ç™»éŒ²ã•ã‚ŒãŸplayerIDã®é…åˆ—

function handlePlayerForRanking(playerId) {
  if (!playerId.startsWith("player-")) {
    displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯ player- ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (rankingList.includes(playerId)) {
    displayMessage(`âš  ${playerMap[playerId]?.name || playerId} ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚`);
    return;
  }

  rankingList.push(playerId);
  displayMessage(`${playerMap[playerId]?.name || playerId} ã‚’é †ä½ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
  updateRankingUI();
}

// ========== é †ä½ç™»éŒ²UIæ›´æ–°ï¼ˆä¸¦ã³æ›¿ãˆå¯èƒ½ãƒªã‚¹ãƒˆï¼‰ ==========

function updateRankingUI() {
  const rankingListEl = document.getElementById("rankingList");
  if (!rankingListEl) return;
  rankingListEl.innerHTML = "";

  rankingList.forEach((id, idx) => {
    const li = document.createElement("li");
    li.className = "ranking-item";
    li.draggable = true;
    li.dataset.playerId = id;
    li.textContent = `${idx + 1}. ${playerMap[id]?.name || id}`;
    rankingListEl.appendChild(li);
  });

  makeRankingSortable();
}

// ========== ä¸¦ã³æ›¿ãˆå¯èƒ½ã«ã™ã‚‹ï¼ˆPCã¨ã‚¹ãƒãƒ›å¯¾å¿œï¼‰ ==========

function makeRankingSortable() {
  const list = document.getElementById("rankingList");
  let dragged;

  list.querySelectorAll("li").forEach(li => {
    // PCç”¨
    li.addEventListener("dragstart", e => {
      dragged = li;
      li.style.opacity = 0.5;
    });

    li.addEventListener("dragend", () => {
      dragged.style.opacity = "";
    });

    li.addEventListener("dragover", e => {
      e.preventDefault();
    });

    li.addEventListener("drop", e => {
      e.preventDefault();
      if (dragged && dragged !== li) {
        const draggedId = dragged.dataset.playerId;
        const targetId = li.dataset.playerId;

        const fromIdx = rankingList.indexOf(draggedId);
        const toIdx = rankingList.indexOf(targetId);

        rankingList.splice(fromIdx, 1);
        rankingList.splice(toIdx, 0, draggedId);

        updateRankingUI();
      }
    });

    // ã‚¹ãƒãƒ›ç”¨
    li.addEventListener("touchstart", e => {
      dragged = li;
      dragged.classList.add("dragged");
    });

    li.addEventListener("touchend", e => {
      dragged?.classList.remove("dragged");
      dragged = null;
    });

    li.addEventListener("touchmove", e => {
      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      if (dragged && target && target.closest && target.closest("li")) {
        const overLi = target.closest("li");
        const draggedId = dragged.dataset.playerId;
        const overId = overLi.dataset.playerId;

        if (draggedId !== overId) {
          const fromIdx = rankingList.indexOf(draggedId);
          const toIdx = rankingList.indexOf(overId);

          rankingList.splice(fromIdx, 1);
          rankingList.splice(toIdx, 0, draggedId);
          updateRankingUI();
        }
      }
    });
  });
}

// ========== é †ä½ç¢ºå®šãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚å‡¦ç† ==========

function confirmRanking() {
  if (rankingList.length === 0) {
    displayMessage("âš  é †ä½ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  if (!confirm("ã“ã®é †ä½ã§ç¢ºå®šã—ã¦ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;

  applyRankingAndCalculateRating(rankingList);
  displayMessage("âœ… é †ä½ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");

  rankingList = [];
  updateRankingUI();
  updateRateTable();
}

// ========== ãƒ¬ãƒ¼ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®ä¾‹ï¼ˆè‡ªç”±ã«æ‹¡å¼µå¯èƒ½ï¼‰ ==========

function applyRankingAndCalculateRating(list) {
  const n = list.length;

  list.forEach((playerId, idx) => {
    const player = playerMap[playerId];
    if (!player) return;

    const prevRate = player.rate || 50;
    let bonus = 0;

    // å˜ç´”ãªä¾‹ï¼š1ä½ +5, 2ä½ +2, 3ä½Â±0, ä»¥ä¸‹ -3
    if (idx === 0) bonus = 5;
    else if (idx === 1) bonus = 2;
    else if (idx === 2) bonus = 0;
    else bonus = -3;

    // ä¸Šé™ãƒ»ä¸‹é™è£œæ­£
    let newRate = Math.max(30, Math.min(99, prevRate + bonus));

    // ä¿å­˜
    player.prevRate = prevRate;
    player.rate = newRate;
    player.lastRank = idx + 1;
    player.bonus = bonus;
  });

  savePlayerMapLocal();
}

// ========== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ ==========

function savePlayerMapLocal() {
  localStorage.setItem("playerMap", JSON.stringify(playerMap));
}

// ========== ãƒ¬ãƒ¼ãƒˆè¡¨UIæ›´æ–° ==========

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
    `;
    table.appendChild(tr);
  });
}
// ========== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ==========

function exportCSV() {
  const header = ["åå‰", "ãƒ¬ãƒ¼ãƒˆ", "å‰å›é †ä½", "å¤‰å‹•", "ç§°å·"];
  const rows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p) || ""
  ]);

  const csvContent = [header, ...rows].map(row =>
    row.map(val => `"${val}"`).join(",")
  ).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "rate_result.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function updateRateTable() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank || "-",
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ä¸¦ã³æ›¿ãˆ
  rows.sort((a, b) => b.rate - a.rate);

  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank}</td>
      <td>${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.title}</td>
    `;
    table.appendChild(tr);
  });
}

// ========== Google Drive é€£æºä¿å­˜ï¼ˆå¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ ==========

async function saveToGoogleDrive(filename, data) {
  if (!window.gapi || !gapi.auth2) {
    console.warn("Google API æœªãƒ­ãƒ¼ãƒ‰ã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚");
    saveToLocalFallback(filename, data);
    return;
  }

  try {
    const authInstance = gapi.auth2.getAuthInstance();
    if (!authInstance.isSignedIn.get()) {
      await authInstance.signIn();
    }

    const fileContent = new Blob([data], { type: 'text/plain' });
    const metadata = {
      name: filename,
      mimeType: 'text/plain'
    };

    const accessToken = gapi.auth.getToken().access_token;

    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", fileContent);

    const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: new Headers({ Authorization: "Bearer " + accessToken }),
      body: form
    });

    if (res.ok) {
      displayMessage("âœ… Google Drive ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
    } else {
      console.warn("Driveä¿å­˜å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚");
      saveToLocalFallback(filename, data);
    }
  } catch (e) {
    console.error("Driveé€£æºã‚¨ãƒ©ãƒ¼", e);
    saveToLocalFallback(filename, data);
  }
}

function saveToLocalFallback(filename, data) {
  const blob = new Blob([data], { type: "text/plain;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  displayMessage("ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
}

// ========== ä¿å­˜ãƒœã‚¿ãƒ³é€£æºå‡¦ç†ï¼ˆCSVï¼‹Driveï¼‰ ==========

function saveAllData() {
  const csvHeader = ["åå‰", "ãƒ¬ãƒ¼ãƒˆ", "å‰å›é †ä½", "å¤‰å‹•", "ç§°å·"];
  const csvRows = Object.values(playerMap).map(p => [
    p.name,
    p.rate ?? 50,
    p.lastRank ?? "-",
    p.bonus ?? 0,
    getTitle(p)
  ]);

  const csvContent = [csvHeader, ...csvRows].map(r =>
    r.map(cell => `"${cell}"`).join(",")
  ).join("\n");

  saveToGoogleDrive("rate_result.csv", csvContent);
}

// ========== æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆHTMLå´ã« #messageBox ãŒå¿…è¦ï¼‰ ==========

function displayMessage(text) {
  const msgEl = document.getElementById("messageBox");
  if (msgEl) {
    msgEl.textContent = text;
    msgEl.style.opacity = 1;
    setTimeout(() => msgEl.style.opacity = 0, 4000);
  } else {
    alert(text);
  }
}
// ========== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¼”å‡º ==========

function showPopup(text, color = "gold") {
  const popup = document.createElement("div");
  popup.textContent = text;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.padding = "1em 2em";
  popup.style.backgroundColor = color;
  popup.style.color = "#000";
  popup.style.fontSize = "24px";
  popup.style.fontWeight = "bold";
  popup.style.borderRadius = "12px";
  popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  popup.style.zIndex = "9999";
  popup.style.opacity = 1;
  document.body.appendChild(popup);

  setTimeout(() => {
    popup.style.transition = "opacity 1s ease, transform 1s ease";
    popup.style.opacity = 0;
    popup.style.transform = "translate(-50%, -70%)";
  }, 800);

  setTimeout(() => {
    popup.remove();
  }, 1800);
}

// ========== é †ä½å¤‰å‹•ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ==========

function updateRateTableWithDiff() {
  const table = document.getElementById("rateTable");
  if (!table) return;

  const rows = Object.entries(playerMap).map(([id, p]) => {
    return {
      id,
      name: p.name,
      rate: p.rate || 50,
      lastRank: p.lastRank ?? null,
      bonus: p.bonus || 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé †ã«ä¸¦ã³æ›¿ãˆ
  rows.sort((a, b) => b.rate - a.rate);

  // é †ä½ã‚’è¨˜éŒ²
  rows.forEach((row, index) => {
    const currentRank = index + 1;
    const player = playerMap[row.id];

    // é †ä½å¤‰å‹•ãƒã‚§ãƒƒã‚¯
    if (player.lastShownRank && player.lastShownRank !== currentRank) {
      const diff = player.lastShownRank - currentRank;
      const symbol = diff > 0 ? "â†‘" : "â†“";
      const movement = Math.abs(diff);
      row.rankDiff = `${symbol}${movement}`;
    } else {
      row.rankDiff = "-";
    }

    // æ¬¡å›æ¯”è¼ƒç”¨ã«ä¿å­˜
    player.lastShownRank = currentRank;
  });

  // è¡¨æ›´æ–°
  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>å¤‰å‹•å·®</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    const bonusColor = row.bonus > 0 ? "limegreen" : row.bonus < 0 ? "tomato" : "#444";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${row.name}</td>
      <td>${row.rate}</td>
      <td>${row.lastRank ?? "-"}</td>
      <td style="color:${bonusColor}">${row.bonus >= 0 ? "+" : ""}${row.bonus}</td>
      <td>${row.rankDiff || "-"}</td>
      <td>${row.title}</td>
    `;

    // å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã«åå¿œï¼‰
    if (row.bonus !== 0) {
      tr.style.animation = "flash 0.8s";
    }

    table.appendChild(tr);
  });
}

// ========== å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³CSSã®è¿½åŠ ï¼ˆ1å›é™ã‚Šï¼‰ ==========

(function addFlashAnimationOnce() {
  const styleId = "flash-css-style";
  if (document.getElementById(styleId)) return;

  const style = document.createElement("style");
  style.id = styleId;
  style.textContent = `
    @keyframes flash {
      0% { background-color: yellow; }
      100% { background-color: inherit; }
    }
    tr[style*="animation: flash"] {
      transition: background-color 1s;
    }
  `;
  document.head.appendChild(style);
})();
    
window.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("rankingTable");
  const rawData = localStorage.getItem("players");

  if (!rawData) {
    table.innerHTML = "<tr><td colspan='6'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>";
    return;
  }

  const players = JSON.parse(rawData);
  const rows = Object.entries(players).map(([id, p]) => {
    return {
      name: p.name,
      rate: p.rate ?? 50,
      lastRank: p.lastRank ?? "-",
      bonus: p.bonus ?? 0,
      title: getTitle(p)
    };
  });

  // ãƒ¬ãƒ¼ãƒˆé™é †ã§ã‚½ãƒ¼ãƒˆ
  rows.sort((a, b) => b.rate - a.rate);

  // è¡¨æç”»
  table.innerHTML = `
    <tr><th>é †ä½</th><th>åå‰</th><th>ãƒ¬ãƒ¼ãƒˆ</th><th>å‰å›é †ä½</th><th>å¤‰å‹•</th><th>ç§°å·</th></tr>
  `;

  rows.forEach((p, i) => {
    const tr = document.createElement("tr");
    const bonusColor = p.bonus > 0 ? "limegreen" : p.bonus < 0 ? "tomato" : "#444";
    const diff = p.lastRank === "-" ? "-" : `${p.lastRank - (i + 1)}`;
    const diffSymbol = diff > 0 ? `â†‘${Math.abs(diff)}` : diff < 0 ? `â†“${Math.abs(diff)}` : "-";

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rate}</td>
      <td>${p.lastRank}</td>
      <td style="color:${bonusColor}">${p.bonus >= 0 ? "+" : ""}${p.bonus}</td>
      <td>${p.title}</td>
    `;

    table.appendChild(tr);
  });
});

// ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸç§°å·ç”Ÿæˆï¼ˆå…±é€šé–¢æ•°ï¼‰
function getTitle(player) {
  const rate = player.rate ?? 50;
  if (rate >= 100) return "ä¼èª¬";
  if (rate >= 90) return "ç¥";
  if (rate >= 80) return "è¦‡è€…";
  if (rate >= 70) return "çŒ›è€…";
  if (rate >= 60) return "å¸¸é€£";
  if (rate >= 50) return "ä¸€èˆ¬";
  if (rate >= 40) return "åˆå¿ƒè€…";
  return "ä¿®è¡Œä¸­";
}

</body>
</html>
