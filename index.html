<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com;">
<title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆå‰Šé™¤æ©Ÿèƒ½ä»˜ãï¼‰</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f4f8;
    color: #333;
    margin: 0; padding: 1rem; text-align: center;
    overflow-x: hidden;
  }
  h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
  #currentSeatDisplay {
    margin: 1rem auto;
    font-size: 1.3rem;
    font-weight: bold;
    max-width: 480px;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background-color: #ffe082; /* æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    color: #5d4037;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #result {
    font-weight: bold;
    background-color: #e0f7fa;
    padding: 0.8rem 1rem;
    margin: 0 auto 1.5rem;
    max-width: 480px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 3rem;
  }
  .button-group {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    max-width: 320px;
    margin: 1rem auto 3rem;
  }
  button {
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  button:hover { background-color: #43a047; }
  button:active { transform: scale(0.97); }
  #completeSeatBtn {
    background-color: #ff9800;
    display: none;
  }
  #completeSeatBtn:hover { background-color: #fb8c00; }
  table {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
    border-collapse: collapse;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  th {
    background-color: #4caf50;
    color: white;
    padding: 10px;
    text-align: left;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  .student {
    display: inline-block;
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 16px;
    margin: 4px 6px 4px 0;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .student:hover {
    background-color: #bbdefb;
  }
  .seat {
    cursor: pointer;
    color: #d32f2f;
    font-weight: bold;
    user-select: none;
    transition: color 0.3s ease;
  }
  .seat:hover {
    color: #b71c1c;
    text-decoration: underline;
  }
  #seatTable tbody tr:hover {
    background-color: #e8f5e9;
  }
  #ranking-select-ui {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    padding: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .ranking-registered {
    background-color: #c8e6c9; /* è–„ã„ç·‘ */
    font-weight: bold;
    border-radius: 4px;
    padding: 2px 6px;
  }
  #sortable-player-list {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  #sortable-player-list li {
    padding: 8px;
    margin: 4px 0;
    background: #e3f2fd;
    border-radius: 4px;
    cursor: move;
    user-select: none;
  }
  #sortable-player-list li.dragging {
    opacity: 0.5;
  }
</style>
</head>
<body>

<h1>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h1>
<p>åº§å¸­ï¼ˆtableã€œï¼‰â†’ ç”Ÿå¾’ï¼ˆplayerã€œï¼‰ã®é †ã«èª­ã¿å–ã‚Šã€‚6äººã¾ã§ç™»éŒ²ã€‚ç”Ÿå¾’IDã‚’ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã€‚</p>

<!-- currentSeat çŠ¶æ…‹è¡¨ç¤º -->
<div id="currentSeatDisplay" aria-live="polite" role="region" aria-label="ç¾åœ¨ã®åº§å¸­é¸æŠçŠ¶æ³">
  ç¾åœ¨ã®åº§å¸­: <span id="currentSeatText">æœªé¸æŠ</span>
</div>

<div id="reader-wrapper"><div id="reader"></div></div>

<div id="result" aria-live="polite" role="status">ã“ã“ã«èª­ã¿å–ã‚ŠçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>

<div class="button-group" role="group" aria-label="æ“ä½œãƒœã‚¿ãƒ³ç¾¤">
  <button onclick="downloadCSV()" aria-label="CSVã§ä¿å­˜">CSVã§ä¿å­˜</button>
  <button id="completeSeatBtn" onclick="completeCurrentSeat()" aria-label="ç¾åœ¨ã®åº§å¸­ç™»éŒ²å®Œäº†ãƒœã‚¿ãƒ³">ã“ã®åº§å¸­ã®ç™»éŒ²ã‚’å®Œäº†</button>
  <button onclick="undoLast()" aria-label="æœ€å¾Œã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã™">æœ€å¾Œã®è¿½åŠ ã‚’å–ã‚Šæ¶ˆã™</button>
  <button onclick="clearSavedData()" aria-label="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ğŸ—‘ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
  <button onclick="saveSeatMapToDrive()" aria-label="Google Driveã«ä¿å­˜">ğŸ’¾ Google Driveã«ä¿å­˜</button>
  <button onclick="loadSeatMapFromDrive()" aria-label="Driveã‹ã‚‰å¾©å…ƒ">â˜ Driveã‹ã‚‰å¾©å…ƒ</button>
  <button onclick="toggleRankingMode()" aria-pressed="false" id="toggleRankingBtn">ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
</div>

<section class="footer-area" aria-label="ç¾åœ¨ã®åº§å¸­ç™»éŒ²çŠ¶æ³">
  <h2>ç¾åœ¨ã®åº§å¸­ç™»éŒ²</h2>
  <table id="seatTable" role="table" aria-describedby="tableDesc">
    <caption id="tableDesc">åº§å¸­IDã¨ç”Ÿå¾’IDä¸€è¦§</caption>
    <thead>
      <tr><th scope="col">åº§å¸­ID</th><th scope="col">ç”Ÿå¾’IDä¸€è¦§</th><th scope="col">é †ä½</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

  let currentSeat = null;
  let seatMap = {};
  let actionHistory = [];
  let lastScanTime = 0;
  let isRankingMode = false;

  let players = JSON.parse(localStorage.getItem("players") || "{}");

  document.addEventListener("DOMContentLoaded", async () => {
    const savedMap = localStorage.getItem("seatMap");
    if (savedMap) {
      seatMap = JSON.parse(savedMap);
      displayMessage("ğŸ“¦ å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
      updateTable();
    } else {
      await loadSeatMapFromDrive();
    }
   function saveRanking(seatID, ranking) {
  // æ—¢å­˜ã®é †ä½ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç„¡ã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  const savedRankings = JSON.parse(localStorage.getItem("seatRankings") || "{}");

  // ä»Šå›ã®åº§å¸­ã®é †ä½ã‚’ä¿å­˜
  savedRankings[seatID] = ranking;

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆæ–‡å­—åˆ—åŒ–ï¼‰
  localStorage.setItem("seatRankings", JSON.stringify(savedRankings));

  console.log(`åº§å¸­ ${seatID} ã®é †ä½ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`, ranking);
} 
    startQrCodeScanner();
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
    updateCurrentSeatDisplay();
  });

  function startQrCodeScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.33
      },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
      displayMessage("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
    });
  }

  function onScanFailure(error) {
    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¯ç„¡è¦–
  }

  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return;
    lastScanTime = now;

    if (!/^(table|player)/.test(decodedText)) {
      displayMessage("â—ä¸æ­£ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚'tableã€œ' ã¾ãŸã¯ 'playerã€œ' ã§å§‹ã‚ã¦ãã ã•ã„ã€‚");
      return;
    }

    if (isRankingMode) {
      if (decodedText.startsWith("table")) {
        if (!seatMap[decodedText]) {
          displayMessage(`âš  åº§å¸­ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${decodedText}`);
          return;
        }
        showRankingSelection(decodedText);
      } else {
        displayMessage("âš  é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã§ã¯åº§å¸­QRã®ã¿èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
      }
      return;
    }

    if (decodedText.startsWith("table")) {
      currentSeat = decodedText;
      if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
      displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚æœ€å¤§6äººã¾ã§ç™»éŒ²å¯èƒ½ã€‚`);
      updateCompleteSeatBtn(true);
      updateTable();
      updateCurrentSeatDisplay();
      return;
    }

    if (decodedText.startsWith("player")) {
      if (!currentSeat) {
        displayMessage("æœ€åˆã«åº§å¸­QRï¼ˆtableã€œï¼‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
        return;
      }
      const people = seatMap[currentSeat];
      if (people.length >= 6) {
        displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã¯6äººã¾ã§ã§ã™ã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚`);
        completeCurrentSeat();
        updateCurrentSeatDisplay();
        return;
      }
      if (people.includes(decodedText)) {
        displayMessage(`ã€Œ${decodedText}ã€ã¯æ—¢ã«åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
        return;
      }
      people.push(decodedText);
      actionHistory.push({ seat: currentSeat, person: decodedText });
      displayMessage(`ã€Œ${decodedText}ã€ã‚’åº§å¸­ã€Œ${currentSeat}ã€ã«ç™»éŒ²ï¼ˆ${people.length}/6ï¼‰`);
      if (people.length >= 6) {
        displayMessage("ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã™ã€‚");
        completeCurrentSeat();
      }
      updateTable();
      updateCurrentSeatDisplay();
    }
  }

  function displayMessage(msg) {
    const el = document.getElementById("result");
    if (el) el.innerText = msg;
  }

  function updateCompleteSeatBtn(show) {
    const btn = document.getElementById("completeSeatBtn");
    if (!btn) return;
    btn.style.display = show ? "inline-block" : "none";
  }

  function updateRankingToggleButton() {
    const btn = document.getElementById("toggleRankingBtn");
    if (!btn) return;
    btn.setAttribute("aria-pressed", isRankingMode.toString());
    btn.textContent = isRankingMode ? "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†" : "ğŸ“‹ é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿";
  }

  function updateCurrentSeatDisplay() {
    const el = document.getElementById("currentSeatText");
    if (!el) return;

    if (!currentSeat) {
      el.textContent = "æœªé¸æŠ";
      el.style.color = "#666";
      el.style.fontWeight = "normal";
    } else {
      const peopleCount = seatMap[currentSeat]?.length || 0;
      el.textContent = `${currentSeat} ï¼ˆç™»éŒ²æ¸ˆã¿ ${peopleCount} / 6 äººï¼‰`;
      el.style.color = "#5d4037";
      el.style.fontWeight = "bold";
    }
  }

ã€€function updateTable() {
    const tbody = document.querySelector("#seatTable tbody");
    tbody.innerHTML = '';
    const savedRankings = JSON.parse(localStorage.getItem("seatRankings") || "{}");

    for (const [seat, people] of Object.entries(seatMap)) {
      const ranking = savedRankings[seat] || [];
      const rankingStr = ranking.length > 0 ? ranking.map((p, i) => `${i + 1}:${p}`).join(' ') : "-";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${seat} <button class="seat" aria-label="åº§å¸­${seat}ã‚’å‰Šé™¤" onclick="removeSeat('${seat}')">âŒ</button></td>
        <td>${people.map(p =>
          `<button class="student" aria-label="ç”Ÿå¾’${p}ã‚’å‰Šé™¤" onclick="removeStudent('${seat}', '${p}')">${p} âŒ</button>`
        ).join(' ')}</td>
        <td>${rankingStr}</td>
      `;
      tbody.appendChild(row);
    }
    // æœ€æ–°ã®seatMapã‚’ä¿å­˜
    localStorage.setItem("seatMap", JSON.stringify(seatMap));
  }

// åº§å¸­ã‹ã‚‰ç”Ÿå¾’ã‚’å‰Šé™¤
function removeStudent(seat, person) {
  const people = seatMap[seat];
  if (!people) return;
  const index = people.indexOf(person);
  if (index !== -1) {
    people.splice(index, 1);
    displayMessage(`åº§å¸­ã€Œ${seat}ã€ã‹ã‚‰ã€Œ${person}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
    updateTable();
    if (seat === currentSeat) updateCurrentSeatDisplay();
    // â€» ã“ã“ã§ã®localStorageä¿å­˜ã¯updateTableã§è¡Œã‚ã‚Œã‚‹ãŸã‚ä¸è¦
  }
}

// åº§å¸­ã”ã¨å‰Šé™¤ï¼ˆç”Ÿå¾’ã‚‚å…¨å“¡æ¶ˆãˆã‚‹ï¼‰
function removeSeat(seat) {
  if (confirm(`åº§å¸­ã€Œ${seat}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”Ÿå¾’ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) {
    delete seatMap[seat];
    displayMessage(`åº§å¸­ã€Œ${seat}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
    if (currentSeat === seat) {
      currentSeat = null;
      updateCompleteSeatBtn(false);
      updateCurrentSeatDisplay();
    }
    updateTable();
    // â€» ã“ã“ã§ã®localStorageä¿å­˜ã¯updateTableã§è¡Œã‚ã‚Œã‚‹ãŸã‚ä¸è¦
  }
}


function completeCurrentSeat() {
  if (currentSeat) {
    displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚`);
    currentSeat = null;
    updateCompleteSeatBtn(false);
    updateCurrentSeatDisplay();
  }
}

  function removeSeat(seat) {
    if (confirm(`åº§å¸­ã€Œ${seat}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”Ÿå¾’ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) {
      delete seatMap[seat];
      displayMessage(`åº§å¸­ã€Œ${seat}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      if (currentSeat === seat) {
        currentSeat = null;
        updateCompleteSeatBtn(false);
        updateCurrentSeatDisplay();
      }
      updateTable();
    }
  }

  function completeCurrentSeat() {
    if (currentSeat) {
      displayMessage(`åº§å¸­ã€Œ${currentSeat}ã€ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚`);
      currentSeat = null;
      updateCompleteSeatBtn(false);
      updateCurrentSeatDisplay();
    }
  }

  function undoLast() {
    if (actionHistory.length === 0) {
      displayMessage("ã“ã‚Œä»¥ä¸Šå–ã‚Šæ¶ˆã›ã‚‹æ“ä½œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    const { seat, person } = actionHistory.pop();
    const people = seatMap[seat];
    if (people) {
      const index = people.lastIndexOf(person);
      if (index !== -1) {
        people.splice(index, 1);
        displayMessage(`ã€Œ${person}ã€ã®ç™»éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚`);
        updateTable();
        if (seat === currentSeat) updateCurrentSeatDisplay();
      }
    }
  }

  function clearSavedData() {
    if (confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem("seatMap");
      localStorage.removeItem("players");
      seatMap = {};
      players = {};
      currentSeat = null;
      displayMessage("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      updateTable();
      updateCurrentSeatDisplay();
      updateCompleteSeatBtn(false);
    }
  }

  function downloadCSV() {
    let csv = "åº§å¸­ID,ç”Ÿå¾’ID\n";
    for (const [seat, people] of Object.entries(seatMap)) {
      people.forEach(person => {
        csv += `${seat},${person}\n`;
      });
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "seat_assignment.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function saveSeatMapToDrive() {
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(seatMap)
  })
  .then(res => res.text())
  .then(text => {
    if (text.includes("saved")) {
      // ä¿å­˜æˆåŠŸæ™‚ã«localStorageã«ã‚‚ç¢ºå®Ÿã«ä¿å­˜
      localStorage.setItem("seatMap", JSON.stringify(seatMap));
      displayMessage("âœ… Google Driveã«ä¿å­˜ã—ã¾ã—ãŸï¼");
    } else {
      displayMessage("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + text);
    }
  })
  .catch(err => {
    console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", err);
    displayMessage("âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  });
}

async function loadSeatMapFromDrive() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("èª­ã¿è¾¼ã¿å¤±æ•—");
    const json = await res.json();
    seatMap = json;
    currentSeat = null;  // å¾©å…ƒæ™‚ã«åº§å¸­é¸æŠãƒªã‚»ãƒƒãƒˆ
    updateTable();
    displayMessage("â˜ Google Driveã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
    localStorage.setItem("seatMap", JSON.stringify(seatMap));
    updateCurrentSeatDisplay();
  } catch (e) {
    displayMessage("âŒ Driveã‹ã‚‰ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error(e);
  }
}


  function toggleRankingMode() {
    isRankingMode = !isRankingMode;
    displayMessage(isRankingMode
      ? "âœ… é †ä½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã—ãŸï¼ˆåº§å¸­QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ï¼‰"
      : "ğŸ“¦ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã—ãŸ");
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
  }

  function showRankingSelection(seatID) {
    const playersInSeat = seatMap[seatID];
    if (!playersInSeat || playersInSeat.length === 0) {
      displayMessage(`åº§å¸­ ${seatID} ã«ç™»éŒ²ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚`);
      return;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«UIã‚³ãƒ³ãƒ†ãƒŠ
    const container = document.createElement("div");
    container.id = "ranking-select-ui";
    container.setAttribute("role", "dialog");
    container.setAttribute("aria-modal", "true");
    container.setAttribute("aria-labelledby", "ranking-title");

    // ã‚¿ã‚¤ãƒˆãƒ«
    const title = document.createElement("h3");
    title.id = "ranking-title";
    title.textContent = `åº§å¸­ ${seatID} ã®é †ä½ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã¹æ›¿ãˆ`;
    container.appendChild(title);

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ
    const list = document.createElement("ul");
    list.id = "sortable-player-list";
    list.setAttribute("tabindex", "0");
    playersInSeat.forEach(player => {
      const li = document.createElement("li");
      li.textContent = player;
      li.setAttribute("draggable", "true");
      list.appendChild(li);
    });
    container.appendChild(list);

    // ãƒœã‚¿ãƒ³ç¾¤
    const btnSave = document.createElement("button");
    btnSave.textContent = "é †ä½ã‚’ç¢ºå®šã™ã‚‹";
    btnSave.setAttribute("aria-label", "é †ä½ã‚’ç¢ºå®šã™ã‚‹ãƒœã‚¿ãƒ³");

    const btnCancel = document.createElement("button");
    btnCancel.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
    btnCancel.setAttribute("aria-label", "é †ä½ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãƒœã‚¿ãƒ³");

    container.appendChild(btnSave);
    container.appendChild(btnCancel);

    document.body.appendChild(container);

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ON
    document.body.style.overflow = "hidden";

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã¹æ›¿ãˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    let draggedItem = null;

    list.addEventListener("dragstart", (e) => {
      draggedItem = e.target;
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", "");
      setTimeout(() => e.target.classList.add("dragging"), 0);
    });

    list.addEventListener("dragend", (e) => {
      e.target.classList.remove("dragging");
      draggedItem = null;
    });

    list.addEventListener("dragover", (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(list, e.clientY);
      if (afterElement == null) {
        list.appendChild(draggedItem);
      } else {
        list.insertBefore(draggedItem, afterElement);
      }
    });

    // ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œï¼ˆã‚¹ãƒãƒ›ï¼‰
    list.addEventListener("touchstart", (e) => {
      draggedItem = e.target.closest("li");
      if (!draggedItem) return;
      draggedItem.classList.add("dragging");
    }, { passive: true });

    list.addEventListener("touchmove", (e) => {
      if (!draggedItem) return;
      e.preventDefault();
      const touch = e.touches[0];
      const afterElement = getDragAfterElement(list, touch.clientY);
      if (afterElement == null) {
        list.appendChild(draggedItem);
      } else {
        list.insertBefore(draggedItem, afterElement);
      }
    }, { passive: false });

    list.addEventListener("touchend", (e) => {
      if (draggedItem) draggedItem.classList.remove("dragging");
      draggedItem = null;
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll("li:not(.dragging)")];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    btnSave.onclick = () => {
      // ç¢ºå®šã—ãŸé †ä½ãƒªã‚¹ãƒˆã‚’å–å¾—
      const ranking = [...list.children].map(li => li.textContent);
      // ä¿å­˜å‡¦ç†ã¯å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…
      saveRanking(seatID, ranking);

      // ç¢ºå®šè¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šèƒŒæ™¯è‰²ãŒä¸€ç¬å¤‰ã‚ã‚‹
      container.style.transition = "background-color 0.5s ease";
      container.style.backgroundColor = "#c8e6c9"; // è–„ã„ç·‘

      setTimeout(() => {
        container.style.backgroundColor = "#fff"; // å…ƒã«æˆ»ã™
        container.remove();
        document.body.style.overflow = ""; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯è§£é™¤
      }, 800);

      isRankingMode = false;
      updateRankingToggleButton();
      displayMessage(`åº§å¸­${seatID}ã®é †ä½ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
    };

    btnCancel.onclick = () => {
      container.remove();
      document.body.style.overflow = ""; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯è§£é™¤
      displayMessage("é †ä½ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
    };
  }

  function saveRanking(seatID, ranking) {
  // æ—¢å­˜ã®é †ä½ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç„¡ã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  const savedRankings = JSON.parse(localStorage.getItem("seatRankings") || "{}");

  // ä»Šå›ã®åº§å¸­ã®é †ä½ã‚’ä¿å­˜
  savedRankings[seatID] = ranking;

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆæ–‡å­—åˆ—åŒ–ï¼‰
  localStorage.setItem("seatRankings", JSON.stringify(savedRankings));

  console.log(`åº§å¸­ ${seatID} ã®é †ä½ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`, ranking);
}
ã€€// ãƒ¬ãƒ¼ãƒˆå¤‰å‹•è¨ˆç®—é–¢æ•°
function calculateRateChange({
  currentRate,
  prevRank,
  newRank,
  totalPlayers,
  lastWasLast = false,
  isTopPlayer = false,
  isLastPlayer = false,
  lastTopPlayerRate = null,
}) {
  let delta = 0;

  // é †ä½ã«ã‚ˆã‚‹åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆå¤‰å‹•
  if (prevRank === 1 && newRank === totalPlayers) {
    // 1ä½ã‹ã‚‰æœ€ä¸‹ä½ã¸ã®æ¸›ç‚¹
    delta = -5;
  } else if (prevRank === totalPlayers && newRank === 1) {
    // æœ€ä¸‹ä½ã‹ã‚‰1ä½ã¸ã®åŠ ç‚¹
    delta = 5;
  } else if (newRank === totalPlayers && lastWasLast) {
    // æœ€ä¸‹ä½é€£ç¶šã®å ´åˆãƒœãƒ¼ãƒŠã‚¹
    delta = 8;
  } else {
    // å˜ç´”ãªé †ä½å·®åˆ†ï¼ˆä¾‹ï¼šå‰å›4ä½â†’ä»Šå›2ä½ã§+2ç‚¹ï¼‰
    delta = prevRank - newRank;
  }

  // é«˜ãƒ¬ãƒ¼ãƒˆè€…è£œæ­£ (80ä»¥ä¸Šã¯0.8å€)
  if (currentRate >= 80) {
    delta = Math.floor(delta * 0.8);
  }

  // ç·åˆ1ä½ã‚ˆã‚Šä¸Šä½ã‚’å–ã£ãŸå ´åˆã®ãƒœãƒ¼ãƒŠã‚¹
  if (isTopPlayer && newRank === 1) {
    delta += 2;
  }

  // æœ€ä¸‹ä½ãŒç·åˆ1ä½ã«å‹ã£ãŸç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹
  if (newRank === 1 && prevRank === totalPlayers && isLastPlayer) {
    delta += 10;
  }

  // æ–°ã—ã„ãƒ¬ãƒ¼ãƒˆè¨ˆç®—
  let newRate = currentRate + delta;

  // æœ€ä½ãƒ¬ãƒ¼ãƒˆ30ä»¥ä¸‹ã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´
  if (newRate < 30) newRate = 30;

  // å¤‰å‹•é‡è¿”å´ï¼ˆUIè¡¨ç¤ºãªã©ã«ä½¿ã†ï¼‰
  return {
    newRate,
    delta,
  };
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ï¼ˆä¾‹ï¼‰
let players = {
  "player001": {
    name: "ã‚¤ãƒã‚´å¤ªéƒ",
    currentRate: 50,
    prevRank: 3,
    lastWasLast: false,
    isTopPlayer: false,
    isLastPlayer: false,
  },
  "player002": {
    name: "ãƒŸã‚«ãƒ³æ¬¡éƒ",
    currentRate: 82,
    prevRank: 1,
    lastWasLast: false,
    isTopPlayer: true,
    isLastPlayer: false,
  },
  // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼...
};

// è©¦åˆçµ‚äº†å¾Œã«é †ä½é…åˆ—ã‚’æ¸¡ã—ã¦æ›´æ–°
function updatePlayersAfterMatch(rankings) {
  const totalPlayers = rankings.length;
  const topPlayerId = rankings[0];
  const topPlayerRate = players[topPlayerId]?.currentRate ?? 50;

  rankings.forEach((playerId, index) => {
    const player = players[playerId];
    if (!player) return;

    const prevRank = player.prevRank || totalPlayers; // å‰å›é †ä½ãŒãªã‘ã‚Œã°æœ€ä¸‹ä½æƒ³å®š
    const newRank = index + 1;
    const isLastPlayer = (playerId === rankings[totalPlayers - 1]);

    const { newRate, delta } = calculateRateChange({
      currentRate: player.currentRate,
      prevRank,
      newRank,
      totalPlayers,
      lastWasLast: player.lastWasLast,
      isTopPlayer: player.isTopPlayer,
      isLastPlayer,
      lastTopPlayerRate: topPlayerRate,
    });

    // æ›´æ–°
    player.currentRate = newRate;
    player.prevRank = newRank;
    player.lastWasLast = (newRank === totalPlayers);
    player.isTopPlayer = (newRank === 1);

    console.log(`${player.name} ã®ãƒ¬ãƒ¼ãƒˆå¤‰å‹•: ${delta} â†’ æ–°ãƒ¬ãƒ¼ãƒˆ: ${newRate}`);
  });
}

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
function savePlayersData() {
  localStorage.setItem("playersData", JSON.stringify(players));
}

// ----------- å‹•ä½œä¾‹ -----------

// ã‚ã‚‹è©¦åˆã®é †ä½ãŒç¢ºå®šã—ãŸã¨ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDé †é…åˆ—ï¼ˆ1ä½ãŒå…ˆé ­ï¼‰
const exampleRanking = ["player002", "player001"];

updatePlayersAfterMatch(exampleRanking);
savePlayersData();

console.log(players);

</script>

</body>
</html>
